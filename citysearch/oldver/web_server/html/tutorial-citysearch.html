

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Find Cities and their Closest Neighbors &mdash; Rampart 0.1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="_static/hacks.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="Rampart 0.1.0 documentation" href="index.html"/>
        <link rel="up" title="Tutorials" href="tutorialtoc.html"/>
        <link rel="next" title="Using Websockets to Build a Chat" href="tutorial-wschat.html"/>
        <link rel="prev" title="Tutorials" href="tutorialtoc.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Rampart
          

          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="rampart-main.html">Rampart JavaScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-utils.html">Rampart Utility Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="sqltoc.html">The rampart-sql module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-server.html">The rampart-server module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-html.html">The rampart-html module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-crypto.html">The rampart-crypto module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-curl.html">The rampart-curl module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-lmdb.html">The rampart-lmdb module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-redis.html">The rampart-redis module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-robots.html">The rampart-robots module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-cmark.html">The rampart-cmark module</a></li>
<li class="toctree-l1"><a class="reference internal" href="rampart-url.html">The rampart-url module</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="tutorialtoc.html">Tutorials</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Find Cities and their Closest Neighbors</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#preface">Preface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#license">License</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#concepts">Concepts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li class="toctree-l3"><a class="reference internal" href="#importing-the-data">Importing the Data</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#examine-your-csv">Examine your CSV</a></li>
<li class="toctree-l4"><a class="reference internal" href="#creating-the-table">Creating the table</a></li>
<li class="toctree-l4"><a class="reference internal" href="#importing-the-csv">Importing the CSV</a></li>
<li class="toctree-l4"><a class="reference internal" href="#computing-geocodes">Computing Geocodes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#building-indexes">Building Indexes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-final-import-script">The Final Import Script</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#web-server-script">Web Server Script</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#web-server-layout">Web Server Layout</a></li>
<li class="toctree-l4"><a class="reference internal" href="#web-server-script-mapping">Web Server Script Mapping</a></li>
<li class="toctree-l4"><a class="reference internal" href="#delivering-static-content">Delivering Static Content</a></li>
<li class="toctree-l4"><a class="reference internal" href="#client-side-scripting">Client-Side Scripting</a></li>
<li class="toctree-l4"><a class="reference internal" href="#formatting-auto-complete-results">Formatting Auto-Complete Results</a></li>
<li class="toctree-l4"><a class="reference internal" href="#finding-and-formatting-nearest-cities">Finding and Formatting Nearest Cities</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-complete-server-side-script">The Complete Server-Side Script</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial-wschat.html">Using Websockets to Build a Chat</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial-pi_news.html">Building a Pi News Aggregator</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Rampart</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="tutorialtoc.html">Tutorials</a> &raquo;</li>
        
      <li>Find Cities and their Closest Neighbors</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorial-citysearch.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="find-cities-and-their-closest-neighbors">
<h1>Find Cities and their Closest Neighbors<a class="headerlink" href="#find-cities-and-their-closest-neighbors" title="Permalink to this headline">¶</a></h1>
<div class="section" id="preface">
<h2>Preface<a class="headerlink" href="#preface" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial, we will use the <a class="reference internal" href="sqltoc.html#the-rampart-sql-module"><span class="std std-ref">SQL module</span></a>
and the <a class="reference internal" href="rampart-server.html#the-rampart-server-http-module"><span class="std std-ref">Server module</span></a>, along
with some client side scripting to create a search of city names, which also
lists the nearest cities to the selected city.</p>
<p>You can download the complete project from our
<a class="reference external" href="https://github.com/aflin/rampart_tutorials">Tutorial Repository</a>
in the <a class="reference external" href="https://github.com/aflin/rampart_tutorials/tree/main/geonames">geonames directory</a>.</p>
<div class="section" id="license">
<h3>License<a class="headerlink" href="#license" title="Permalink to this headline">¶</a></h3>
<p>The code related to this tutorial is released under the MIT license.
The data used to populate the database is licensed under a
<a class="reference external" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons License</a>.</p>
</div>
</div>
<div class="section" id="concepts">
<h2>Concepts<a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a></h2>
<p>This module will demonstrate:</p>
<ul class="simple">
<li><p>Using the <a class="reference internal" href="sqltoc.html#the-rampart-sql-module"><span class="std std-ref">SQL module</span></a> to
<a class="reference internal" href="rampart-sql.html#importcsvfile"><span class="std std-ref">import</span></a> csv data.</p></li>
<li><p>Using the <a class="reference internal" href="sqltoc.html#the-rampart-sql-module"><span class="std std-ref">SQL module</span></a> to create a Fulltext search for
the client side autocomplete search.</p></li>
<li><p>Using the <a class="reference internal" href="sql-server-funcs.html#geographical-coordinate-functions"><span class="std std-ref">SQL geocode functions</span></a>
to encode latitude/longitude pairs for each entry in the database, and to
find the closest cities to any given latitude/longitude pair.</p></li>
</ul>
<p>In order to complete this tutorial, you should have basic knowledge of
JavaScript, SQL and client side scripting using JavaScript (a passing
knowledge of jQuery is also helpful).  This tutorial will not provide an
in-depth explanation of how client-side scripting works.</p>
</div>
<div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>In order to search by name and by location, we need to create a database
that contains both place names and latitude/longitude information.
Fortunately, the good folks at <a class="reference external" href="http://www.geonames.org/">GeoNames.org</a>
have provided us a CSV formatted file that accomplishes that and which is
licensed under a
<a class="reference external" href="https://creativecommons.org/licenses/by/4.0/">Creative Commons License</a>.</p>
<p>You can navigate to <a class="reference external" href="http://download.geonames.org/export/zip/">http://download.geonames.org/export/zip/</a> and choose
the file that suits your needs.  In this tutorial, we will use the world
database titled <a class="reference external" href="http://download.geonames.org/export/zip/allCountries.zip">AllCountries.zip</a>.</p>
<p>Your first task will be to download your file of choice and unzip it in a
working directory (here we use <code class="docutils literal notranslate"><span class="pre">~/geonames/</span></code>).  We will assume your
working directory contains the <code class="docutils literal notranslate"><span class="pre">allCountries.txt</span></code> file.</p>
</div>
<div class="section" id="importing-the-data">
<h2>Importing the Data<a class="headerlink" href="#importing-the-data" title="Permalink to this headline">¶</a></h2>
<div class="section" id="examine-your-csv">
<h3>Examine your CSV<a class="headerlink" href="#examine-your-csv" title="Permalink to this headline">¶</a></h3>
<p>The first step for importing a CSV file is to have a look at the format of the
data in the file.  CSV can vary quite a bit, and to import it, we will want to
know a few thing such as (but not limited to):</p>
<ul class="simple">
<li><p>Does every column contain the same type?</p></li>
<li><p>Are text columns quoted?</p></li>
<li><p>Are single quotes present inside unquoted text fields?</p></li>
<li><p>Are records separated by <code class="docutils literal notranslate"><span class="pre">,</span></code> or by <code class="docutils literal notranslate"><span class="pre">\t</span></code>?</p></li>
<li><p>Is there a header row as the first line in the file?</p></li>
</ul>
<p>Let’s examine the first few rows of <code class="docutils literal notranslate"><span class="pre">allCountries.txt</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ head ./allCountries.txt
AD      AD100   Canillo Canillo 02                                      42.5833 1.6667  6
AD      AD200   Encamp  Encamp  03                                      42.5333 1.6333  6
AD      AD400   La Massana      La Massana      04                                      42.5667 1.4833  6
AD      AD300   Ordino  Ordino  05                                      42.6    1.55    6
AD      AD600   Sant Julià de Lòria     Sant Julià de Lòria     06                                      42.4667 1.5     6
AD      AD500   Andorra la Vella        Andorra la Vella        07                                      42.5    1.5     6
AD      AD700   Escaldes-Engordany      Escaldes-Engordany      08                                      42.5    1.5667  6
AR      3636    POZO CERCADO (EL CHORRO (F), DPTO. RIVADAVIA (S))       Salta   A                                       -23.4933        -61.9267        3
AR      4123    LAS SALADAS     Salta   A                                       -25.7833        -64.5   4
AR      4126    TALA    Salta   A                                       -26.1167        -65.2833        4
</pre></div>
</div>
<p>Immediately we can see that records are separated by tabs (<code class="docutils literal notranslate"><span class="pre">\t</span></code>), that the second column (postal codes)
has both number and text types and that text fields are not quoted.  Also the first row appears to be data, and not
column names.</p>
<p>Next let’s check if there are embedded single quotes in text fields:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grep</span> <span class="s2">&quot;&#39;&quot;</span> <span class="o">./</span><span class="n">allCountries</span><span class="o">.</span><span class="n">txt</span> <span class="o">|</span> <span class="n">head</span>
<span class="n">AR</span>      <span class="mi">6646</span>    <span class="n">GENERAL</span> <span class="n">O</span><span class="s1">&#39;BRIEN Buenos Aires    B                                       -34.9   -60.75  4</span>
<span class="n">AR</span>      <span class="mi">6748</span>    <span class="n">O</span><span class="s1">&#39;HIGGINS       Buenos Aires    B                                       -34.5833        -60.7   4</span>
<span class="n">AR</span>      <span class="mi">7541</span>    <span class="n">D</span><span class="s1">&#39;ORBIGNY       Buenos Aires    B                                       -37.6833        -61.7167        4</span>
<span class="n">AR</span>      <span class="mi">8514</span>    <span class="n">VICEALMIRANTE</span> <span class="n">EDUARDO</span> <span class="n">O</span><span class="s1">&#39;CONNOR (ESTACION FCGR)  Rio Negro       R                                       -40.7722        -63.9889        3</span>
<span class="n">AR</span>      <span class="mi">2117</span>    <span class="n">COLONIA</span> <span class="n">O</span><span class="s1">&#39;FARRELL       Santa Fe        S                                       -33.3278        -60.8694        1</span>
<span class="n">AR</span>      <span class="mi">3050</span>    <span class="n">LUCIO</span> <span class="n">D</span><span class="s1">&#39;ABREU   Santa Fe        S                                       -29.9   -60.3   3</span>
<span class="n">AR</span>      <span class="mi">3358</span>    <span class="n">COLONIA</span> <span class="n">LIEBIG</span><span class="s1">&#39;S        Corrientes      W                                       -27.9   -55.8583        3</span>
<span class="n">AR</span>      <span class="mi">2645</span>    <span class="n">CAPITAN</span> <span class="n">GENERAL</span> <span class="n">BERNARDO</span> <span class="n">O</span><span class="s1">&#39;HIGGINS      Cordoba X                                       -33.25  -62.2833        4</span>
<span class="n">AR</span>      <span class="mi">2645</span>    <span class="n">PIEDRAS</span> <span class="n">ANCHAS</span> <span class="p">(</span><span class="n">CAP</span><span class="o">.</span><span class="n">GRAL</span><span class="o">.</span><span class="n">B</span><span class="o">.</span><span class="n">O</span><span class="s1">&#39;HIGGINS, DPTO.MARCOS JUAREZ)       Cordoba X                                       -33.2708        -62.2375     3</span>
<span class="n">AU</span>      <span class="mi">2602</span>    <span class="n">O</span><span class="s1">&#39;Connor        Australian Capital Territory    ACT     CANBERRA                                -35.2584        149.1202        4</span>
</pre></div>
</div>
<p>And indeed there are single quotes in place names.</p>
<p>So to answer our earlier questions:</p>
<ul class="simple">
<li><p>Does every column contain the same type? – <span class="red">NO</span></p></li>
<li><p>Are text columns quoted?  – <span class="red">NO</span></p></li>
<li><p>Are single quotes present inside unquoted text fields? – <span class="green">YES</span></p></li>
<li><p>Are records separated by <code class="docutils literal notranslate"><span class="pre">,</span></code> or by <code class="docutils literal notranslate"><span class="pre">\t</span></code>?  – <span class="green">Uses tabs</span></p></li>
<li><p>Is there a header row as the first line in the file? <span class="red">NO</span></p></li>
</ul>
<p>Note that although the file is separated by tabs, we will continue to use the term
<code class="docutils literal notranslate"><span class="pre">CSV</span></code>.</p>
<p>Next lets find out which field is which.  According to GeoNames.org:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">data</span> <span class="nb">format</span> <span class="ow">is</span> <span class="n">tab</span><span class="o">-</span><span class="n">delimited</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">utf8</span> <span class="n">encoding</span><span class="p">,</span> <span class="k">with</span> <span class="n">the</span> <span class="n">following</span> <span class="n">fields</span> <span class="p">:</span>

<span class="n">country</span> <span class="n">code</span>      <span class="p">:</span> <span class="n">iso</span> <span class="n">country</span> <span class="n">code</span><span class="p">,</span> <span class="mi">2</span> <span class="n">characters</span>
<span class="n">postal</span> <span class="n">code</span>       <span class="p">:</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">place</span> <span class="n">name</span>        <span class="p">:</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span>
<span class="n">admin</span> <span class="n">name1</span>       <span class="p">:</span> <span class="mf">1.</span> <span class="n">order</span> <span class="n">subdivision</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">admin</span> <span class="n">code1</span>       <span class="p">:</span> <span class="mf">1.</span> <span class="n">order</span> <span class="n">subdivision</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">admin</span> <span class="n">name2</span>       <span class="p">:</span> <span class="mf">2.</span> <span class="n">order</span> <span class="n">subdivision</span> <span class="p">(</span><span class="n">county</span><span class="o">/</span><span class="n">province</span><span class="p">)</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">admin</span> <span class="n">code2</span>       <span class="p">:</span> <span class="mf">2.</span> <span class="n">order</span> <span class="n">subdivision</span> <span class="p">(</span><span class="n">county</span><span class="o">/</span><span class="n">province</span><span class="p">)</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">admin</span> <span class="n">name3</span>       <span class="p">:</span> <span class="mf">3.</span> <span class="n">order</span> <span class="n">subdivision</span> <span class="p">(</span><span class="n">community</span><span class="p">)</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="n">admin</span> <span class="n">code3</span>       <span class="p">:</span> <span class="mf">3.</span> <span class="n">order</span> <span class="n">subdivision</span> <span class="p">(</span><span class="n">community</span><span class="p">)</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="n">latitude</span>          <span class="p">:</span> <span class="n">estimated</span> <span class="n">latitude</span> <span class="p">(</span><span class="n">wgs84</span><span class="p">)</span>
<span class="n">longitude</span>         <span class="p">:</span> <span class="n">estimated</span> <span class="n">longitude</span> <span class="p">(</span><span class="n">wgs84</span><span class="p">)</span>
<span class="n">accuracy</span>          <span class="p">:</span> <span class="n">accuracy</span> <span class="n">of</span> <span class="n">lat</span><span class="o">/</span><span class="n">lng</span> <span class="kn">from</span> <span class="mi">1</span><span class="o">=</span><span class="n">estimated</span><span class="p">,</span> <span class="mi">4</span><span class="o">=</span><span class="n">geonameid</span><span class="p">,</span> <span class="mi">6</span><span class="o">=</span><span class="n">centroid</span> <span class="n">of</span> <span class="n">addresses</span> <span class="ow">or</span> <span class="n">shape</span>
</pre></div>
</div>
<p>From this we can see that except for <code class="docutils literal notranslate"><span class="pre">latitude</span></code>, <code class="docutils literal notranslate"><span class="pre">longitude</span></code> and <code class="docutils literal notranslate"><span class="pre">accuracy</span></code>, every one of our fields
is text.  While the <code class="docutils literal notranslate"><span class="pre">country</span> <span class="pre">code</span></code> is always 2 characters, the rest of the fields are of variable length.</p>
<p>Armed with this knowledge, we are ready to create a script that imports our data.</p>
</div>
<div class="section" id="creating-the-table">
<h3>Creating the table<a class="headerlink" href="#creating-the-table" title="Permalink to this headline">¶</a></h3>
<p>In our SQL table, we will create a column for each column of the CSV file.
In addition we will add two more columns.</p>
<p>The first will be a Texis <code class="docutils literal notranslate"><span class="pre">counter</span></code> type.  This will be used to create
a unique identifier for each row (similar to a primary key, but automatically
generated).</p>
<p>The second requires a bit of knowledge of how a bounded geographic search works.
We will get to that later.  For now, trust that you need another field that is
typed as <code class="docutils literal notranslate"><span class="pre">long</span></code>.  We will call it <code class="docutils literal notranslate"><span class="pre">geocode</span></code>.</p>
<p>So let’s create a script that will make our table.</p>
<p>To begin, we need to load the SQL module and open a database;</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Sql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="s2">&quot;~/geonames/geonames_db&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</pre></div>
</div>
<p>In the above code, the <code class="docutils literal notranslate"><span class="pre">var</span> <span class="pre">Sql</span> <span class="pre">=</span> <span class="pre">require(&quot;rampart-sql&quot;);</span></code> line
loads the SQL module that is distributed with Rampart as
<code class="docutils literal notranslate"><span class="pre">rampart-sql.so</span></code>.  The second line,
<code class="docutils literal notranslate"><span class="pre">var</span> <span class="pre">sql</span> <span class="pre">=</span> <span class="pre">new</span> <span class="pre">Sql.init(&quot;~geonames/geonames_db&quot;,</span> <span class="pre">true);</span></code> opens the database.</p>
<p>Note the <code class="docutils literal notranslate"><span class="pre">true</span></code> in <code class="docutils literal notranslate"><span class="pre">Sql.init()</span></code>.  It signifies that if the database
does not exist, create the directory and the metadata files necessary
for a new, blank database.</p>
<p>When creating a new database, be sure that:</p>
<ul class="simple">
<li><p>The directory does not (yet) exist (it will be created).  If
it exists and does not contain the metadata files, the opening
of the database will fail.</p></li>
<li><p>The parent directory (in this case <code class="docutils literal notranslate"><span class="pre">./</span></code>) does exist, and that
you have read/write permissions.</p></li>
</ul>
<p>So now that we have the code to open, and optionally create our
database, let’s make our table.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Sql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>

 <span class="c1">// use process.scriptPath to make sure we have the</span>
 <span class="c1">// correct path if running from another working directory</span>
 <span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">scriptPath</span> <span class="o">+</span> <span class="s2">&quot;/geonames_db&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

 <span class="c1">// put the create statement into its own function</span>
 <span class="c1">// since we are doing this in stages</span>

 <span class="kd">function</span> <span class="nx">create_table</span><span class="p">()</span> <span class="p">{</span>

     <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create table geonames (&quot;</span> <span class="o">+</span>
         <span class="s2">&quot;id           counter, &quot;</span>       <span class="o">+</span>
         <span class="s2">&quot;country_code char(2), &quot;</span>       <span class="o">+</span>
         <span class="s2">&quot;postal_code  varchar(8), &quot;</span>    <span class="o">+</span>
         <span class="s2">&quot;place_name   varchar(16), &quot;</span>   <span class="o">+</span>
         <span class="s2">&quot;admin_name1  varchar(16), &quot;</span>   <span class="o">+</span>
         <span class="s2">&quot;admin_code1  varchar(8), &quot;</span>    <span class="o">+</span>
         <span class="s2">&quot;admin_name2  varchar(16), &quot;</span>   <span class="o">+</span>
         <span class="s2">&quot;admin_code2  varchar(8), &quot;</span>    <span class="o">+</span>
         <span class="s2">&quot;admin_name3  varchar(16), &quot;</span>   <span class="o">+</span>
         <span class="s2">&quot;admin_code3  varchar(8), &quot;</span>    <span class="o">+</span>
         <span class="s2">&quot;latitude     double, &quot;</span>        <span class="o">+</span>
         <span class="s2">&quot;longitude    double, &quot;</span>        <span class="o">+</span>
         <span class="s2">&quot;geocode      long, &quot;</span>          <span class="o">+</span>
         <span class="s2">&quot;accuracy     int           );&quot;</span>
     <span class="p">);</span>

 <span class="p">}</span>

 <span class="nx">create_table</span><span class="p">();</span>
</pre></div>
</div>
<p>This should all be self expanatory.  If not, please brush up on
your <a class="reference external" href="https://www.w3schools.com/sql/sql_create_table.asp">SQL</a>.</p>
<p>Note though that <code class="docutils literal notranslate"><span class="pre">varchar(x)</span></code> in Texis SQL, the size <code class="docutils literal notranslate"><span class="pre">x</span></code> is
merely a suggestion.  If the text put into this field is larger
that what is specified, it will not truncate the text or affect any indexing.</p>
<p>Now we have our table.  Let’s get that data in!</p>
</div>
<div class="section" id="importing-the-csv">
<h3>Importing the CSV<a class="headerlink" href="#importing-the-csv" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-settings">
<h4>The Settings<a class="headerlink" href="#the-settings" title="Permalink to this headline">¶</a></h4>
<p>The SQL module has a convenient function to import CSV data.  It has many options
and often takes careful examination of the data to be imported to get it correct.
Fortunately the large number of options allows us to get well formatted
CSV data imported correctly.</p>
<p>See the section for <a class="reference internal" href="rampart-sql.html#importcsvfile"><span class="std std-ref">importCsvFile()</span></a> for a full
listing.</p>
<p>Knowing what we discovered when we examined the <code class="docutils literal notranslate"><span class="pre">allCountries.txt</span></code> file above, we
can make our <code class="docutils literal notranslate"><span class="pre">importCsvFile()</span></code> call look like this:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">importCsvFile</span><span class="p">(</span>
    <span class="s2">&quot;allCountries.txt&quot;</span><span class="p">,</span>  <span class="c1">//file to import</span>
    <span class="p">{</span>
        <span class="nx">normalize</span><span class="o">:</span>       <span class="kc">false</span><span class="p">,</span>
        <span class="nx">singleQuoteNest</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">delimiter</span><span class="o">:</span>       <span class="s1">&#39;\t&#39;</span><span class="p">,</span>
        <span class="nx">hasHeaderRow</span><span class="o">:</span>    <span class="kc">false</span><span class="p">,</span>
        <span class="nx">tableName</span><span class="o">:</span>       <span class="s2">&quot;geonames&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="cm">/* numbers are column-in positions (-1 means leave blank, or add counter if field type is &#39;counter&#39;)</span>
<span class="cm">       position in array is column-out positions  */</span>
    <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">]</span>
<span class="p">);</span>
</pre></div>
</div>
<p>So the <span class="green">Object</span> of settings passed to <code class="docutils literal notranslate"><span class="pre">importCsvFile()</span></code> addresses the answers to all our
questions above (<code class="docutils literal notranslate"><span class="pre">singleQuoteNest:</span> <span class="pre">false</span></code> is because there are single quotes present AND they
are not quoted in double quotes – one setting for those two questions).</p>
<p>We also pass an array (<code class="docutils literal notranslate"><span class="pre">[-1,0,1,2,3,4,5,6,7,8,9,10,-1,11]</span></code>).</p>
<p>Column numbers start at <code class="docutils literal notranslate"><span class="pre">0</span></code> and end at <code class="docutils literal notranslate"><span class="pre">n-1</span></code> columns.</p>
<p>The array is like the layout of a SQL table row.  The numbers in the array
correspond to columns in the CSV.  As such, the array lets the import
function know which columns from the CSV file go to which columns in the SQL
table.</p>
<p>In this case, column 0 in the SQL database is a <code class="docutils literal notranslate"><span class="pre">counter</span></code> type.
We want this to be created automatically.  So the first member of this array
(<code class="docutils literal notranslate"><span class="pre">-1</span></code>) tells the import function to fill the first column in the SQL
database with the default value.</p>
<p>For default values using <code class="docutils literal notranslate"><span class="pre">-1</span></code>, the actual value depends on the column
type.  For <code class="docutils literal notranslate"><span class="pre">varchar</span></code> it is a blank string.  For <code class="docutils literal notranslate"><span class="pre">int</span></code> it is <code class="docutils literal notranslate"><span class="pre">0</span></code>.  And
for <code class="docutils literal notranslate"><span class="pre">counter</span></code> it is a unique number based on a time stamp and a counter
value.</p>
<p>Moving on, the second number in the array is <code class="docutils literal notranslate"><span class="pre">0</span></code> (“[-1,<span class="red">0</span>,1,…]”).  Since it is in the <code class="docutils literal notranslate"><span class="pre">array[1]</span></code> position, it refers to column 1
(the second column) of SQL table.  Since it is <code class="docutils literal notranslate"><span class="pre">0</span></code>, the data from column 0
of the CSV will be used to populate column 1 of the SQL table.</p>
<p>The rest follow suit with column 1 of the CSV populating column 2 of the
SQL table and so on.</p>
<p>We want to insert zeros into the <cite>geocode</cite> field since it will be calculated
later.  Hence there is the <code class="docutils literal notranslate"><span class="pre">-1</span></code> in the <code class="docutils literal notranslate"><span class="pre">array[12]</span></code> position (again,
starting at 0; “[-1,0,1,2,3,4,5,6,7,8,9,10,<span class="red">-1</span>,11]).</p>
<p>We are ready to import the data.  But before we do, we know this will take a bit of time.
Let’s set up a function to monitor the progress so we aren’t staring at a blank screen
wondering when the import will be finished.</p>
</div>
<div class="section" id="monitoring-the-import">
<h4>Monitoring the Import<a class="headerlink" href="#monitoring-the-import" title="Permalink to this headline">¶</a></h4>
<p>There are two major stages at which we can monitor the import.  The first
is while <code class="docutils literal notranslate"><span class="pre">importCsvFile()</span></code> is analysing the data, and the second is
as the data is being inserted into the SQL table.</p>
<p>In the first, analysis stage, a monitoring function is passed two parameters:
<code class="docutils literal notranslate"><span class="pre">monitor_import(count,</span> <span class="pre">stage)</span></code>.  The analysis takes at least two passes.
If <code class="docutils literal notranslate"><span class="pre">normalize</span></code>, is set <code class="docutils literal notranslate"><span class="pre">true</span></code>, two more passes are added for each column.</p>
<p>Note that the first stage is significantly faster than the second.  Therefore if your
dataset is not very large, you might want to skip reporting on the progress
of the first page.</p>
<p>In the second, insert stage, a monitoring function is passed only one parameter:
<code class="docutils literal notranslate"><span class="pre">monitor_import(count)</span></code>.  There is only one pass for the second stage.</p>
<p>Knowing this, we can write a single function to print out our progress, which may be used
at either of or both of the major stages.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// cuz no one likes writing out &#39;rampart.utils.printf()&#39;</span>
<span class="nx">rampart</span><span class="p">.</span><span class="nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class="p">.</span><span class="nx">utils</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">//set in importCsvFile(), only report every 100th row</span>
<span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//we won&#39;t know the total until we finish the first pass</span>

<span class="kd">function</span> <span class="nx">monitor_import</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">stg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stage</span> <span class="o">=</span> <span class="s2">&quot;Import&quot;</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stg</span><span class="o">!==</span><span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// progressfunc</span>
        <span class="nx">stage</span><span class="o">=</span><span class="nx">stg</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stg</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//differentiate between 0 and undefined</span>
    <span class="p">{</span>
        <span class="nx">total</span><span class="o">=</span><span class="nx">count</span><span class="p">;</span> <span class="c1">//update our total in the first stage.</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d       \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d of %d      \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>

<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="putting-it-together">
<h4>Putting it Together<a class="headerlink" href="#putting-it-together" title="Permalink to this headline">¶</a></h4>
<p>Putting this all together, and using the <code class="docutils literal notranslate"><span class="pre">callbackStep</span></code> and <code class="docutils literal notranslate"><span class="pre">progressStep</span></code>
settings, we end up with this:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// cuz no one likes writing out &#39;rampart.utils.printf()&#39;</span>
<span class="nx">rampart</span><span class="p">.</span><span class="nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class="p">.</span><span class="nx">utils</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">//set in importCsvFile(), only report every 100th row</span>
<span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//we won&#39;t know the total until we finish the first pass</span>

<span class="kd">function</span> <span class="nx">monitor_import</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">stg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stage</span> <span class="o">=</span> <span class="s2">&quot;Import&quot;</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stg</span><span class="o">!==</span><span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// progressfunc</span>
        <span class="nx">stage</span><span class="o">=</span><span class="nx">stg</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stg</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//differentiate between 0 and undefined</span>
    <span class="p">{</span>
        <span class="nx">total</span><span class="o">=</span><span class="nx">count</span><span class="p">;</span> <span class="c1">//update our total in the first stage.</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d       \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d of %d      \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>

<span class="p">}</span>

<span class="nx">total</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">importCsvFile</span><span class="p">(</span>
    <span class="s2">&quot;allCountries.txt&quot;</span><span class="p">,</span>  <span class="c1">//file to import</span>
    <span class="p">{</span>
        <span class="nx">normalize</span><span class="o">:</span>       <span class="kc">false</span><span class="p">,</span>
        <span class="nx">singleQuoteNest</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="nx">delimiter</span><span class="o">:</span>       <span class="s1">&#39;\t&#39;</span><span class="p">,</span>
        <span class="nx">hasHeaderRow</span><span class="o">:</span>    <span class="kc">false</span><span class="p">,</span>
        <span class="nx">tableName</span><span class="o">:</span>       <span class="s2">&quot;geonames&quot;</span><span class="p">,</span>
        <span class="nx">callbackStep</span><span class="o">:</span>    <span class="nx">step</span><span class="p">,</span> <span class="c1">//callback run every 100th row</span>
        <span class="nx">progressStep</span><span class="o">:</span>    <span class="nx">step</span><span class="p">,</span> <span class="c1">//progressfunc run every 100th row for each stage</span>
        <span class="nx">progressFunc</span><span class="o">:</span>    <span class="nx">monitor_import</span> <span class="c1">//progress function while processing csv</span>
    <span class="p">},</span>
    <span class="cm">/* numbers are column-in positions (-1 means leave blank, or add counter if field type is &#39;counter&#39;)</span>
<span class="cm">       position in array is column-out positions  */</span>
    <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">],</span>
    <span class="nx">monitor_import</span> <span class="c1">//callback function upon actual import</span>
<span class="p">);</span>
<span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span><span class="c1">//end with a newline</span>
</pre></div>
</div>
</div>
<div class="section" id="the-script-thus-far">
<h4>The Script Thus Far<a class="headerlink" href="#the-script-thus-far" title="Permalink to this headline">¶</a></h4>
<p>We can wrap the import into its own function and add it to our script from above:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Sql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>

<span class="c1">// use process.scriptPath to make sure we have the</span>
<span class="c1">// correct path if running from another working directory</span>
<span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">scriptPath</span> <span class="o">+</span> <span class="s2">&quot;/geonames_db&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="c1">// cuz no one likes writing out &#39;rampart.utils.printf()&#39;</span>
<span class="nx">rampart</span><span class="p">.</span><span class="nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class="p">.</span><span class="nx">utils</span><span class="p">);</span>

<span class="c1">// put the create statement into its own function</span>
<span class="c1">// since we are doing this in stages</span>

<span class="kd">function</span> <span class="nx">create_table</span><span class="p">()</span> <span class="p">{</span>

    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create table geonames (&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;id           counter, &quot;</span>       <span class="o">+</span>
        <span class="s2">&quot;country_code char(2), &quot;</span>       <span class="o">+</span>
        <span class="s2">&quot;postal_code  varchar(8), &quot;</span>    <span class="o">+</span>
        <span class="s2">&quot;place_name   varchar(16), &quot;</span>   <span class="o">+</span>
        <span class="s2">&quot;admin_name1  varchar(16), &quot;</span>   <span class="o">+</span>
        <span class="s2">&quot;admin_code1  varchar(8), &quot;</span>    <span class="o">+</span>
        <span class="s2">&quot;admin_name2  varchar(16), &quot;</span>   <span class="o">+</span>
        <span class="s2">&quot;admin_code2  varchar(8), &quot;</span>    <span class="o">+</span>
        <span class="s2">&quot;admin_name3  varchar(16), &quot;</span>   <span class="o">+</span>
        <span class="s2">&quot;admin_code3  varchar(8), &quot;</span>    <span class="o">+</span>
        <span class="s2">&quot;latitude     double, &quot;</span>        <span class="o">+</span>
        <span class="s2">&quot;longitude    double, &quot;</span>        <span class="o">+</span>
        <span class="s2">&quot;geocode      long, &quot;</span>          <span class="o">+</span>
        <span class="s2">&quot;accuracy     int           );&quot;</span>
    <span class="p">);</span>

<span class="p">}</span>


<span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">//set in importCsvFile(), only report every 100th row</span>
<span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//we won&#39;t know the total until we finish the first pass</span>

<span class="cm">/* a single function to monitor the import for both pre-processing (progressFunc)</span>
<span class="cm">   and import (callback function supplied to sql.importCsvFile as a paramater)   */</span>
<span class="kd">function</span> <span class="nx">monitor_import</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">stg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stage</span> <span class="o">=</span> <span class="s2">&quot;Import&quot;</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stg</span><span class="o">!==</span><span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// progressfunc</span>
        <span class="nx">stage</span><span class="o">=</span><span class="nx">stg</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stg</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//differentiate between 0 and undefined</span>
    <span class="p">{</span>
        <span class="nx">total</span><span class="o">=</span><span class="nx">count</span><span class="p">;</span> <span class="c1">//update our total in the first stage.</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d       \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d of %d      \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">import_data</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">total</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">importCsvFile</span><span class="p">(</span>
        <span class="s2">&quot;allCountries.txt&quot;</span><span class="p">,</span>  <span class="c1">//file to import</span>
        <span class="p">{</span>
            <span class="nx">normalize</span><span class="o">:</span>       <span class="kc">false</span><span class="p">,</span>
            <span class="nx">singleQuoteNest</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">delimiter</span><span class="o">:</span>       <span class="s1">&#39;\t&#39;</span><span class="p">,</span>
            <span class="nx">hasHeaderRow</span><span class="o">:</span>    <span class="kc">false</span><span class="p">,</span>
            <span class="nx">tableName</span><span class="o">:</span>       <span class="s2">&quot;geonames&quot;</span><span class="p">,</span>
            <span class="nx">callbackStep</span><span class="o">:</span>    <span class="nx">step</span><span class="p">,</span> <span class="c1">//callback run every 100th row</span>
            <span class="nx">progressStep</span><span class="o">:</span>    <span class="nx">step</span><span class="p">,</span> <span class="c1">//progressfunc run every 100th row for each stage</span>
            <span class="nx">progressFunc</span><span class="o">:</span>    <span class="nx">monitor_import</span> <span class="c1">//progress function while processing csv</span>
        <span class="p">},</span>
        <span class="cm">/* numbers are column-in positions (-1 means leave blank, or add counter if field type is &#39;counter&#39;)</span>
<span class="cm">           position in array is column-out positions  */</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">],</span>
        <span class="nx">monitor_import</span> <span class="c1">//callback function upon actual import</span>
    <span class="p">);</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span><span class="c1">//end with a newline</span>
<span class="p">}</span>

<span class="nx">create_table</span><span class="p">();</span>
<span class="nx">import_data</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="computing-geocodes">
<h3>Computing Geocodes<a class="headerlink" href="#computing-geocodes" title="Permalink to this headline">¶</a></h3>
<p>Now we have all the data from the CSV imported into the SQL table.  But
remember the <code class="docutils literal notranslate"><span class="pre">geocode</span></code> field?  They have all been set to <code class="docutils literal notranslate"><span class="pre">0</span></code>.  So what
is this field for?  We will use it to store a “geocode” that allows us to
search bounded regions.  The function <code class="docutils literal notranslate"><span class="pre">latlon2geocode</span></code> will compute it for
us using the latitude and longitude already in each row of the table.</p>
<p>According to the <a class="reference internal" href="sql-server-funcs.html#latlon2geocode-latlon2geocodearea"><span class="std std-ref">documentation</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>The latlon2geocode function encodes a given latitude/longitude coordinate
into one long return value.  This encoded value – a “geocode” value – can
be indexed and used with a special variant of Texis’ BETWEEN operator for
bounded-area searches of a geographical region.
</pre></div>
</div>
<p>That is exactly what we need to efficiently search for other places close to a given one.</p>
<p>So lets compute that field.  Fortunately it can be done in a single sql statement:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">update</span> <span class="n">geonames</span> <span class="k">set</span> <span class="n">geocode</span> <span class="o">=</span> <span class="n">latlon2geocode</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">);</span>
</pre></div>
</div>
<p>Once again, let’s wrap that in a function and put it in our script:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">make_geocode</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Computing geocode column:\n&quot;</span><span class="p">);</span>

    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;update geonames set geocode = latlon2geocode(latitude, longitude);&quot;</span><span class="p">,</span>
             <span class="c1">//monitor our progress with a callback</span>
             <span class="kd">function</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                 <span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="nx">i</span><span class="o">%</span><span class="mi">100</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                     <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;%d of %d    \r&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
                     <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
                 <span class="p">}</span>
             <span class="p">}</span>
    <span class="p">);</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span><span class="c1">//end with a newline</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Like magic, we now have everything we need to do a geographic bounded search.</p>
<p>Lets prove it.  After computing the <code class="docutils literal notranslate"><span class="pre">geocode</span></code> column, lets find zip codes
in Oakland, CA and surrounding cities.  From the command line, we will use
the <code class="docutils literal notranslate"><span class="pre">tsql</span></code> utility to try this out.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ tsql -l 30 -d geonames_db/ &quot;select place_name, postal_code,
  distlatlon(37.8, -122.3, latitude, longitude) MilesAway
  from geonames where geocode between (select latlon2geocodearea(37.8, -122.3, 0.2)) order by 3 asc&quot;

 place_name  postal_code   MilesAway
------------+------------+------------+
Oakland      94615            0.463117
Oakland      94607            0.949234
Oakland      94604             1.62171
Oakland      94623             1.62171
Oakland      94624             1.62171
Oakland      94649             1.62171
Oakland      94659             1.62171
Oakland      94660             1.62171
Oakland      94661             1.62171
Oakland      94666             1.62171
Oakland      94617              1.6351
Oakland      94612             1.90388
Emeryville   94662             2.30697
Emeryville   94608             2.73752
Alameda      94501             2.79463
Oakland      94606             3.12938
Oakland      94610             3.16062
Oakland      94609              3.1832
Oakland      94622             3.61777
Piedmont     94620             4.09376
San Francisco 94130             4.10287
Berkeley     94701             4.18801
Oakland      94618             4.41511
Berkeley     94703             4.56013
Berkeley     94702             4.60167
Oakland      94601             4.74365
Berkeley     94705             4.79358
Berkeley     94710             4.81075
Oakland      94602             4.88881
San Francisco 94105             4.95664
</pre></div>
</div>
<p>Yes, that worked.  But why was it so slow?</p>
</div>
<div class="section" id="building-indexes">
<h3>Building Indexes<a class="headerlink" href="#building-indexes" title="Permalink to this headline">¶</a></h3>
<div class="section" id="the-geocode-index">
<h4>The geocode index<a class="headerlink" href="#the-geocode-index" title="Permalink to this headline">¶</a></h4>
<p>We need to create an index to speed up the bounded “geocode” search above.
And we should do that in our script.  And once again, we are going to wrap
it in a function.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">make_geocode_index</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating index on geocode\n&quot;</span><span class="p">);</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create index geonames_geocode_x on geonames(geocode) WITH INDEXMETER &#39;on&#39;;&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A couple of things to note:</p>
<p>First – when this index is made, it will backed by a
file named <code class="docutils literal notranslate"><span class="pre">geonames_geocode_x.btr</span></code>.  It is so named because it will be
easy to find using <code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-l</span></code> (it will come right before the table, named
<code class="docutils literal notranslate"><span class="pre">geonames.tbl</span></code>, and it lets you know the field indexed (<code class="docutils literal notranslate"><span class="pre">_geocode</span></code>) and
the type of index (<code class="docutils literal notranslate"><span class="pre">_x</span></code> for plain index, i.e.  - not Fulltext or unique).
Your methodology for naming indexes is not as important as making sure you
are consistent, can read it and know what the index is for without having to
resort to looking it up.</p>
<p>However if you do not know what an index is for, you can always look it up in the System
Catalog:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># tsql -d geonames_db/ &quot;select * from SYSINDEX where NAME=&#39;geonames_geocode_x&#39;&quot;</span>

    <span class="n">NAME</span>        <span class="n">TBNAME</span>       <span class="n">FNAME</span>       <span class="n">COLLSEQ</span>        <span class="n">TYPE</span>      <span class="n">NON_UNIQUE</span>     <span class="n">FIELDS</span>       <span class="n">PARAMS</span>
<span class="o">------------+------------+------------+------------+------------+------------+------------+------------+</span>
<span class="n">geonames_geocode_x</span> <span class="n">geonames</span>     <span class="n">geonames_geocode_x</span> <span class="n">A</span>            <span class="n">B</span>                      <span class="mi">01</span> <span class="n">geocode</span>      <span class="n">stringcomparemode</span><span class="o">=</span><span class="n">unicodemulti</span><span class="p">,</span><span class="n">respectcase</span><span class="p">;</span>
</pre></div>
</div>
<p>Second –  note the <code class="docutils literal notranslate"><span class="pre">WITH</span> <span class="pre">INDEXMETER</span> <span class="pre">'on'</span></code> in the SQL statement.  This will tell
Texis to print a pretty meter to let you know the progress of your index creation.</p>
<p>When you have built your index, try the <code class="docutils literal notranslate"><span class="pre">tsql</span></code> query above again.  It should be much, much faster.</p>
</div>
<div class="section" id="the-id-index">
<h4>The id index<a class="headerlink" href="#the-id-index" title="Permalink to this headline">¶</a></h4>
<p>Eventually, when we write our client-side script, we will want to look up records based on the
<code class="docutils literal notranslate"><span class="pre">id</span> <span class="pre">counter</span></code> field.  So we will make a function to make an index on that as well.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">make_id_index</span><span class="p">(){</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating index on id\n&quot;</span><span class="p">);</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create index geonames_id_x on geonames(id) WITH INDEXMETER &#39;on&#39;;&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-fulltext-index">
<h4>The Fulltext index<a class="headerlink" href="#the-fulltext-index" title="Permalink to this headline">¶</a></h4>
<p>When making a Fulltext index, often it is best to leave most settings as is.  The one exception
is the <a class="reference internal" href="rampart-sql.html#rex"><span class="std std-ref">rex</span></a> expressions used to define what is a word.
Often we want to make sure we include utf-8 encoded text.</p>
<p>The default is <code class="docutils literal notranslate"><span class="pre">\alnum{2,99}</span></code>, which is similar to doing <code class="docutils literal notranslate"><span class="pre">mydoc.match(/[a-zA-Z0-9]+/g)</span></code>.
Since we are processing utf-8 text, and since we have names of places from all over the world,
we had better accommodate bytes larger than <code class="docutils literal notranslate"><span class="pre">0x79</span></code>.</p>
<p>To change the expression used during Fulltext index creation, we can use
<a class="reference internal" href="sql-set.html#delexp"><span class="std std-ref">delExp</span></a> and <a class="reference internal" href="sql-set.html#addexp"><span class="std std-ref">addExp</span></a>.  However
as a shortcut, we can specify the expressions that will be used in the SQL
statement itself by utilizing the <code class="docutils literal notranslate"><span class="pre">WITH</span></code> keyword:</p>
<p><code class="docutils literal notranslate"><span class="pre">WITH</span> <span class="pre">WORDEXPRESSIONS</span> <span class="pre">('[\\alnum\\x80-\\xFF]{2,99}')</span></code></p>
<p>That will find words consisting of 7-bit ascii letters and numbers, plus utf-8 multibyte characters as well.</p>
<p>Now we also have a database that does not contain normal text.  It is worth
thinking about where this might bite us when we perform a search.  Let’s
look at the <a class="reference internal" href="sql-set.html#noiselist"><span class="std std-ref">list of noise words</span></a>.  The excluded
<code class="docutils literal notranslate"><span class="pre">us</span></code>, <code class="docutils literal notranslate"><span class="pre">to</span></code> and <code class="docutils literal notranslate"><span class="pre">in</span></code> look suspect.  They are the same as some of our
country codes.  And <code class="docutils literal notranslate"><span class="pre">or</span></code> is an <code class="docutils literal notranslate"><span class="pre">admin_code1</span></code> abbreviation for Oregon.</p>
<p>Normally when searching normal English text, removing all the noise words
would hurt performance.  However, in this very specific circumstance, noise
words serve no purpose.  Further, they will exclude some codes we want in
our index.  So we will delete the noiseList.</p>
<p>You should always have a very good reason for altering or deleting the
noiseList.  For English text, there is rarely a need to do so and it can
have adverse consequences on performance and quality of results.  However,
this time we do have a good reason.</p>
<p>Now - what exactly do we want to index?  Naturally we want to be able to
look up a place based upon any of the text fields.  So we will create one
“virtual” field made up of all our text fields.  To do that, in the SQL
statement we separate all the fields using a <code class="docutils literal notranslate"><span class="pre">\</span></code>; But since it is
JavaScript, we will need to escape the backslash with another backslash.  We
should end up with this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">place_name</span>\\<span class="n">postal_code</span>\\<span class="n">admin_name1</span>\\<span class="n">admin_code1</span>\\<span class="n">country_code</span>\\<span class="n">admin_name2</span>\\<span class="n">admin_code2</span>\\<span class="n">admin_name3</span>\\<span class="n">admin_code3</span>
</pre></div>
</div>
<p>Ordering is important.  The queries we will do later, that have matches at
the beginning of our virtual field will match higher than those at the end.
(This, along with other ranking knobs can be adjusted – see
<a class="reference internal" href="sql-set.html#rank-knobs"><span class="std std-ref">Rank Knobs</span></a>).</p>
<p>So, let’s see our SQL statement, within a <code class="docutils literal notranslate"><span class="pre">sql.exec()</span></code>, in its own function:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">make_text_index</span><span class="p">(){</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating indexes on location names\n&quot;</span><span class="p">);</span>

    <span class="c1">// noiselist as detailed at https://rampart.dev/docs/sql-set.html#noiselist</span>
    <span class="c1">// This is not English text and some geographic abbreviations like OR IN DO TO SO and US</span>
    <span class="c1">// are also on the noise words list.</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="nx">noiseList</span><span class="o">:</span><span class="p">[]});</span>

    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create fulltext index geonames_textcols_ftx on geonames&quot;</span><span class="o">+</span>
        <span class="s2">&quot;(place_name\\postal_code\\admin_name1\\admin_code1\\country_code\\admin_name2\\admin_code2\\admin_name3\\admin_code3)&quot;</span><span class="o">+</span>
        <span class="s2">&quot; WITH WORDEXPRESSIONS (&#39;[\\alnum\\x80-\\xFF]{2,99}&#39;) INDEXMETER &#39;on&#39;;&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="the-final-import-script">
<h3>The Final Import Script<a class="headerlink" href="#the-final-import-script" title="Permalink to this headline">¶</a></h3>
<p>We put it all together and it looks something like this:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">Sql</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>

<span class="c1">// use process.scriptPath to make sure we have the</span>
<span class="c1">// correct path if running from another working directory</span>
<span class="kd">var</span> <span class="nx">sql</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">scriptPath</span> <span class="o">+</span> <span class="s2">&quot;/geonames_db&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>

<span class="c1">// cuz no one likes writing out &#39;rampart.utils.printf()&#39;</span>
<span class="nx">rampart</span><span class="p">.</span><span class="nx">globalize</span><span class="p">(</span><span class="nx">rampart</span><span class="p">.</span><span class="nx">utils</span><span class="p">);</span>

<span class="c1">// put the create statement into its own function</span>
<span class="c1">// since we are doing this in stages</span>

<span class="kd">function</span> <span class="nx">create_table</span><span class="p">()</span> <span class="p">{</span>

    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create table geonames (&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;id           counter, &quot;</span>       <span class="o">+</span>
        <span class="s2">&quot;country_code char(2), &quot;</span>       <span class="o">+</span>
        <span class="s2">&quot;postal_code  varchar(8), &quot;</span>    <span class="o">+</span>
        <span class="s2">&quot;place_name   varchar(16), &quot;</span>   <span class="o">+</span>
        <span class="s2">&quot;admin_name1  varchar(16), &quot;</span>   <span class="o">+</span>
        <span class="s2">&quot;admin_code1  varchar(8), &quot;</span>    <span class="o">+</span>
        <span class="s2">&quot;admin_name2  varchar(16), &quot;</span>   <span class="o">+</span>
        <span class="s2">&quot;admin_code2  varchar(8), &quot;</span>    <span class="o">+</span>
        <span class="s2">&quot;admin_name3  varchar(16), &quot;</span>   <span class="o">+</span>
        <span class="s2">&quot;admin_code3  varchar(8), &quot;</span>    <span class="o">+</span>
        <span class="s2">&quot;latitude     double, &quot;</span>        <span class="o">+</span>
        <span class="s2">&quot;longitude    double, &quot;</span>        <span class="o">+</span>
        <span class="s2">&quot;geocode      long, &quot;</span>          <span class="o">+</span>
        <span class="s2">&quot;accuracy     int           );&quot;</span>
    <span class="p">);</span>

<span class="p">}</span>


<span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">//set in importCsvFile(), only report every 100th row</span>
<span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="c1">//we won&#39;t know the total until we finish the first pass</span>

<span class="cm">/* a single function to monitor the import for both pre-processing (progressFunc)</span>
<span class="cm">   and import (callback function supplied to sql.importCsvFile as a paramater)   */</span>
<span class="kd">function</span> <span class="nx">monitor_import</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">stg</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">stage</span> <span class="o">=</span> <span class="s2">&quot;Import&quot;</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">count</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;\n&quot;</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stg</span><span class="o">!==</span><span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// progressfunc</span>
        <span class="nx">stage</span><span class="o">=</span><span class="nx">stg</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nx">stg</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="c1">//differentiate between 0 and undefined</span>
    <span class="p">{</span>
        <span class="nx">total</span><span class="o">=</span><span class="nx">count</span><span class="p">;</span> <span class="c1">//update our total in the first stage.</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d       \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Stage: %s, Count: %d of %d      \r&quot;</span><span class="p">,</span> <span class="nx">stage</span><span class="p">,</span> <span class="nx">count</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">import_data</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">total</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">importCsvFile</span><span class="p">(</span>
        <span class="s2">&quot;allCountries.txt&quot;</span><span class="p">,</span>  <span class="c1">//file to import</span>
        <span class="p">{</span>
            <span class="nx">normalize</span><span class="o">:</span>       <span class="kc">false</span><span class="p">,</span>
            <span class="nx">singleQuoteNest</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nx">delimiter</span><span class="o">:</span>       <span class="s1">&#39;\t&#39;</span><span class="p">,</span>
            <span class="nx">hasHeaderRow</span><span class="o">:</span>    <span class="kc">false</span><span class="p">,</span>
            <span class="nx">tableName</span><span class="o">:</span>       <span class="s2">&quot;geonames&quot;</span><span class="p">,</span>
            <span class="nx">callbackStep</span><span class="o">:</span>    <span class="nx">step</span><span class="p">,</span> <span class="c1">//callback run every 100th row</span>
            <span class="nx">progressStep</span><span class="o">:</span>    <span class="nx">step</span><span class="p">,</span> <span class="c1">//progressfunc run every 100th row for each stage</span>
            <span class="nx">progressFunc</span><span class="o">:</span>    <span class="nx">monitor_import</span> <span class="c1">//progress function while processing csv</span>
        <span class="p">},</span>
        <span class="cm">/* numbers are column-in positions (-1 means leave blank, or add counter if field type is &#39;counter&#39;)</span>
<span class="cm">           position in array is column-out positions  */</span>
        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">11</span><span class="p">],</span>
        <span class="nx">monitor_import</span> <span class="c1">//callback function upon actual import</span>
    <span class="p">);</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span><span class="c1">//end with a newline</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">make_geocode</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;Computing geocode column:\n&quot;</span><span class="p">);</span>

    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;update geonames set geocode = latlon2geocode(latitude, longitude);&quot;</span><span class="p">,</span>
             <span class="c1">//monitor our progress with a callback</span>
             <span class="kd">function</span><span class="p">(</span><span class="nx">row</span><span class="p">,</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
                 <span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="p">(</span><span class="nx">i</span><span class="o">%</span><span class="mi">100</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                     <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;%d of %d    \r&quot;</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">total</span><span class="p">);</span>
                     <span class="nx">fflush</span><span class="p">(</span><span class="nx">stdout</span><span class="p">);</span>
                 <span class="p">}</span>
             <span class="p">}</span>
    <span class="p">);</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">);</span><span class="c1">//end with a newline</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">make_geocode_index</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating index on geocode\n&quot;</span><span class="p">);</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create index geonames_geocode_x on geonames(geocode) WITH INDEXMETER &#39;on&#39;;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">make_id_index</span><span class="p">(){</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating index on id\n&quot;</span><span class="p">);</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create index geonames_id_x on geonames(id) WITH INDEXMETER &#39;on&#39;;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">make_text_index</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;creating indexes on location names\n&quot;</span><span class="p">);</span>

    <span class="c1">// noiselist as detailed at https://rampart.dev/docs/sql-set.html#noiselist</span>
    <span class="c1">// This is not English text and some geographic abbreviations like OR IN DO TO SO and US</span>
    <span class="c1">// are also on the noise words list.</span>
    <span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span> <span class="nx">noiseList</span><span class="o">:</span><span class="p">[]});</span>

    <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="s2">&quot;create fulltext index geonames_textcols_ftx on geonames&quot;</span><span class="o">+</span>
        <span class="s2">&quot;(place_name\\postal_code\\admin_name1\\admin_code1\\country_code\\admin_name2\\admin_code2\\admin_name3\\admin_code3)&quot;</span><span class="o">+</span>
        <span class="s2">&quot; WITH WORDEXPRESSIONS (&#39;[\\alnum\\x80-\\xFF]{2,99}&#39;) INDEXMETER &#39;on&#39;;&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">create_table</span><span class="p">();</span>
<span class="nx">import_data</span><span class="p">();</span>
<span class="nx">make_geocode</span><span class="p">();</span>
<span class="nx">make_geocode_index</span><span class="p">();</span>
<span class="nx">make_id_index</span><span class="p">();</span>
<span class="nx">make_text_index</span><span class="p">();</span>

<span class="nx">printf</span><span class="p">(</span><span class="s2">&quot;All Done\n&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="web-server-script">
<h2>Web Server Script<a class="headerlink" href="#web-server-script" title="Permalink to this headline">¶</a></h2>
<div class="section" id="web-server-layout">
<h3>Web Server Layout<a class="headerlink" href="#web-server-layout" title="Permalink to this headline">¶</a></h3>
<p>In the Rampart binary distribution is a sample web server tree.  For our
purposes here, we assume you have downloaded and unzipped the Rampart binary
distribution into a directory named <code class="docutils literal notranslate"><span class="pre">~/downloads/rampart</span></code>. We will use
that for this project.
The <a class="reference internal" href="rampart-server.html#the-rampart-server-http-module"><span class="std std-ref">The rampart-server HTTP module</span></a>
is configured and loaded from the included <code class="docutils literal notranslate"><span class="pre">web_server/web_server_conf.js</span></code>
script.  It defines <code class="docutils literal notranslate"><span class="pre">web_server/html</span></code> as the default directory for static
html, <code class="docutils literal notranslate"><span class="pre">web_server/apps</span></code> as the default directory for scripts and
<code class="docutils literal notranslate"><span class="pre">web_server/data</span></code> as a standard location for databases.</p>
<p>To get started, copy the <code class="docutils literal notranslate"><span class="pre">web_server</span></code> directory to a convenient place for
this project, then copy the <code class="docutils literal notranslate"><span class="pre">geonames_db</span></code> folder to
<code class="docutils literal notranslate"><span class="pre">web_server/data/geonames_db</span></code>.  Also, for our purposes, we do not need
anything in the <code class="docutils literal notranslate"><span class="pre">web_server/apps/test_modules</span></code> or
<code class="docutils literal notranslate"><span class="pre">web_server/apps/wsapps</span></code> directories, so you can delete the copy of those
files. We will also add an empty file for our web interface at
<code class="docutils literal notranslate"><span class="pre">web_server/apps/citysearch.js</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>user@localhost:~$ mkdir citysearch_demo
user@localhost:~$ cd citysearch_demo
user@localhost:~/citysearch_demo$ cp -a ~/downloads/rampart/web_server ./
user@localhost:~/citysearch_demo$ cd web_server/
user@localhost:~/citysearch_demo/web_server$ cp -a ~/geonames/geonames_db data/
user@localhost:~/citysearch_demo/web_server$ sudo chown -R nobody data/geonames_db/
user@localhost:~/citysearch_demo/web_server$ rm -rf apps/test_modules wsapps/* html/index.html
user@localhost:~/citysearch_demo/web_server$ touch ./apps/citysearch.js
user@localhost:~/citysearch_demo/web_server$ find .
.
./start_server.sh
./stop_server.sh
./web_server_conf.js
./apps
./apps/citysearch.js
./html
./html/images
./html/images/inigo-not-fount.jpg
./logs
./data
./data/geonames_db
./data/geonames_db/SYSUSERS.tbl
./data/geonames_db/geonames.tbl
./data/geonames_db/geonames_textcols_ftx_P.tbl
./data/geonames_db/geonames_textcols_ftx.tok
./data/geonames_db/geonames_textcols_ftx_D.btr
./data/geonames_db/geonames_geocode_x.btr
./data/geonames_db/geonames_textcols_ftx_T.btr
./data/geonames_db/SYSPERMS.tbl
./data/geonames_db/SYSINDEX.tbl
./data/geonames_db/geonames_textcols_ftx.btr
./data/geonames_db/SYSSTATS.tbl
./data/geonames_db/SYSCOLUMNS.tbl
./data/geonames_db/SYSTABLES.tbl
./data/geonames_db/geonames_textcols_ftx.dat
./data/geonames_db/SYSMETAINDEX.tbl
./data/geonames_db/geonames_id_x.btr
./data/geonames_db/SYSTRIG.tbl
./wsapps
</pre></div>
</div>
</div>
<div class="section" id="web-server-script-mapping">
<h3>Web Server Script Mapping<a class="headerlink" href="#web-server-script-mapping" title="Permalink to this headline">¶</a></h3>
<p>We will start by editing the <code class="docutils literal notranslate"><span class="pre">apps/citysearch.js</span></code> file in order to map
functions to urls.</p>
<p>With your preferred editor, open the <code class="docutils literal notranslate"><span class="pre">apps/citysearch.js</span></code> file and
use this stub script as our starting point:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Load the sql module</span>
<span class="kd">var</span> <span class="nx">Sql</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>

<span class="c1">// serverConf is defined in web_server/web_server_conf.js</span>
<span class="kd">var</span> <span class="nx">sql</span><span class="o">=</span><span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">serverConf</span><span class="p">.</span><span class="nx">dataRoot</span> <span class="o">+</span> <span class="s1">&#39;/geonames_db&#39;</span><span class="p">);</span>

<span class="c1">// function stubs</span>
<span class="kd">function</span> <span class="nx">htmlpage</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">ajaxres</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">autocomp</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>


<span class="c1">// url to function mapping</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;/&quot;</span><span class="o">:</span>               <span class="nx">htmlpage</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/</span>
    <span class="s2">&quot;/index.html&quot;</span><span class="o">:</span>     <span class="nx">htmlpage</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/index.html</span>
    <span class="s2">&quot;/autocomp.json&quot;</span><span class="o">:</span>  <span class="nx">autocomp</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/autocomp.json</span>
    <span class="s2">&quot;/ajaxres.json&quot;</span><span class="o">:</span>   <span class="nx">ajaxres</span>    <span class="c1">//http://localhost:8088/apps/citysearch/ajaxres.json</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Notice that <code class="docutils literal notranslate"><span class="pre">module.exports</span></code> is set to an <span class="green">Object</span>.  This allows a
single module script to serve pages at multiple URLs.  Here <code class="docutils literal notranslate"><span class="pre">/</span></code> and
<code class="docutils literal notranslate"><span class="pre">/index.html</span></code> will be used to return html and <code class="docutils literal notranslate"><span class="pre">/autocomp.json</span></code> and
<code class="docutils literal notranslate"><span class="pre">/ajaxres.json</span></code> will be used for AJAX requests and will return JSON.</p>
</div>
<div class="section" id="delivering-static-content">
<h3>Delivering Static Content<a class="headerlink" href="#delivering-static-content" title="Permalink to this headline">¶</a></h3>
<p>Looking at the stub script above, there are two distinct times that the code
therein will be run: 1) once upon module load and 2) upon each request from
a client as mapped in the <code class="docutils literal notranslate"><span class="pre">module.exports</span></code> <span class="green">Object</span>.  For security
purposes, it is important to keep this in mind as you write scripts.
Variables set in the module outside of the <code class="docutils literal notranslate"><span class="pre">htmlpage()</span></code>, <code class="docutils literal notranslate"><span class="pre">ajaxres()</span></code> and
<code class="docutils literal notranslate"><span class="pre">autocomp()</span></code> functions are long lived and span multiple requests.</p>
<p>That being said, we can set a single variable in the script to deliver
static content.  It only needs to be loaded once as it contains the
html and client side javascript that will be delivered to every client, and
does not change.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Load the sql module</span>
<span class="kd">var</span> <span class="nx">Sql</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>

<span class="c1">// serverConf is defined in web_server/web_server_conf.js</span>
<span class="kd">var</span> <span class="nx">sql</span><span class="o">=</span><span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">serverConf</span><span class="p">.</span><span class="nx">dataRoot</span> <span class="o">+</span> <span class="s1">&#39;/geonames_db&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">client_script</span> <span class="o">=</span> <span class="sb">`</span>
<span class="sb">    // client-side javascript goes here</span>
<span class="sb">`</span><span class="p">;</span>


<span class="c1">// page is defined once upon script load here rather than upon each request in</span>
<span class="c1">// htmlpage() below.</span>
<span class="kd">var</span> <span class="nx">page</span><span class="o">=</span><span class="sb">`&lt;!DOCTYPE HTML&gt;</span>
<span class="sb">&lt;html&gt;</span>
<span class="sb">    &lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="sb">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="sb">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="sb">    &lt;style&gt;</span>
<span class="sb">        body,h1,h2,h3,h4,h5,h6 {font-family: &quot;Varela Round&quot;, Sans-Serif;}</span>
<span class="sb">        .autocomplete-suggestions {</span>
<span class="sb">            border: 1px solid #999;</span>
<span class="sb">            background: #FFF;</span>
<span class="sb">            overflow: auto;</span>
<span class="sb">            width: auto !important;</span>
<span class="sb">            padding-right:5px;</span>
<span class="sb">        }</span>
<span class="sb">        .autocomplete-suggestion {</span>
<span class="sb">            padding: 2px 5px;</span>
<span class="sb">            white-space: nowrap;</span>
<span class="sb">            overflow: hidden;</span>
<span class="sb">        }</span>
<span class="sb">        .autocomplete-suggestions strong {</span>
<span class="sb">            font-weight: normal;</span>
<span class="sb">            color: #3399FF;</span>
<span class="sb">        }</span>
<span class="sb">        .autocomplete-group strong {</span>
<span class="sb">            display: block;</span>
<span class="sb">            border-bottom: 1px solid #000;</span>
<span class="sb">        }</span>
<span class="sb">        .autocomplete-selected { background: #F0F0F0; }</span>
<span class="sb">        .autocomplete-group { padding: 2px 5px; }</span>
<span class="sb">        .zip { display: inline-block; width:140px;}</span>
<span class="sb">        #main {</span>
<span class="sb">            background-color: white;</span>
<span class="sb">            margin: auto;</span>
<span class="sb">            min-height: 300px;</span>
<span class="sb">            width: 600px;</span>
<span class="sb">        }</span>
<span class="sb">        #idiv {</span>
<span class="sb">            width:500px;</span>
<span class="sb">            height:39px;</span>
<span class="sb">            border-bottom: lightGray 1px solid;</span>
<span class="sb">            padding:15px 0px 15px 0px;</span>
<span class="sb">        }</span>
<span class="sb">        #cstextbox {</span>
<span class="sb">            min-width:150px;</span>
<span class="sb">            width:100%;</span>
<span class="sb">            height:30px;</span>
<span class="sb">            font:normal 18px arial,sans-serif;</span>
<span class="sb">            padding: 1px 3px;</span>
<span class="sb">            border: 2px solid #ccc;</span>
<span class="sb">            box-sizing: border-box;</span>
<span class="sb">        }</span>
<span class="sb">    &lt;/style&gt;</span>
<span class="sb">    &lt;title&gt;City Search Tutorial&lt;/title&gt;</span>
<span class="sb">    &lt;/head&gt;</span>
<span class="sb">    &lt;body&gt;</span>
<span class="sb">    &lt;div id=&quot;main&quot;&gt;</span>
<span class="sb">      &lt;form id=&quot;mf&quot;&gt;</span>
<span class="sb">          &lt;div id=&quot;idiv&quot;&gt;</span>
<span class="sb">              &lt;input type=&quot;text&quot; id=&quot;cstextbox&quot; name=&quot;q&quot; value=&quot;&quot; placeholder=&quot;Search for a city&quot;&gt;</span>
<span class="sb">          &lt;/div&gt;</span>
<span class="sb">      &lt;/form&gt;</span>
<span class="sb">      &lt;div id=&quot;res&quot;&gt;&lt;/div&gt;</span>
<span class="sb">      &lt;/body&gt;</span>
<span class="sb">      &lt;script&gt;</span>
<span class="sb">          </span><span class="si">${</span><span class="nx">client_script</span><span class="si">}</span><span class="sb"></span>
<span class="sb">      &lt;/script&gt;</span>
<span class="sb">&lt;/html&gt;`</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">htmlpage</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// just return the html.</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">html</span><span class="o">:</span><span class="nx">page</span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">ajaxres</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">autocomp</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>


<span class="c1">// url to function mapping</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;/&quot;</span><span class="o">:</span>               <span class="nx">htmlpage</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/</span>
    <span class="s2">&quot;/index.html&quot;</span><span class="o">:</span>     <span class="nx">htmlpage</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/index.html</span>
    <span class="s2">&quot;/autocomp.json&quot;</span><span class="o">:</span>  <span class="nx">autocomp</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/autocomp.json</span>
    <span class="s2">&quot;/ajaxres.json&quot;</span><span class="o">:</span>   <span class="nx">ajaxres</span>    <span class="c1">//http://localhost:8088/apps/citysearch/ajaxres.json</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The variable <code class="docutils literal notranslate"><span class="pre">page</span></code> is set to a basic web page with a form and text box for
searching, as well as loading some external JavaScript.  We will use the
variable <code class="docutils literal notranslate"><span class="pre">client_script</span></code> for our inline client-side scripting.</p>
<p>We will use the text input in the form to search for cities and load the
nearest cities, displaying the results in the <code class="docutils literal notranslate"><span class="pre">&lt;div</span> <span class="pre">id=&quot;res&quot;&gt;&lt;/div&gt;</span></code> div
at the bottom of the page.</p>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">page</span></code> variable is returned in an <span class="green">Object</span> at
the end of the <code class="docutils literal notranslate"><span class="pre">htmlpage()</span></code> function (<code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">{html:page};</span></code>).  The
property <code class="docutils literal notranslate"><span class="pre">html</span></code> sets the mime-type of the returned page to <code class="docutils literal notranslate"><span class="pre">text/html</span></code>
and the value is set to the <code class="docutils literal notranslate"><span class="pre">page</span></code> variable to set the content to
be returned to the client.</p>
</div>
<div class="section" id="client-side-scripting">
<h3>Client-Side Scripting<a class="headerlink" href="#client-side-scripting" title="Permalink to this headline">¶</a></h3>
<p>In order to make the AJAX autocomplete search, we will use
<a class="reference external" href="https://jquery.com/">jQuery</a> and
<a class="reference external" href="https://github.com/devbridge/jQuery-Autocomplete">jQuery-Autocomplete</a>,
both of which are included at the top of the script.  Please see the
<a class="reference external" href="https://github.com/devbridge/jQuery-Autocomplete">jQuery-Autocomplete page</a>
for more information on how it works.</p>
<p>Below is our script so far, with the client-side JavaScript added.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Load the sql module</span>
<span class="kd">var</span> <span class="nx">Sql</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>

<span class="c1">// serverConf is defined in web_server/web_server_conf.js</span>
<span class="kd">var</span> <span class="nx">sql</span><span class="o">=</span><span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">serverConf</span><span class="p">.</span><span class="nx">dataRoot</span> <span class="o">+</span> <span class="s1">&#39;/geonames_db&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">useKilometers</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">distvar</span> <span class="o">=</span> <span class="s2">&quot;mi&quot;</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="nx">useKilometers</span><span class="p">)</span>
    <span class="nx">distvar</span> <span class="o">=</span> <span class="s2">&quot;km&quot;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">client_script</span> <span class="o">=</span> <span class="sb">`</span>
<span class="sb">// function to get query parameters from url</span>
<span class="sb">function getparams() {</span>
<span class="sb">    if (window.location.search.length==0)</span>
<span class="sb">        return {};</span>

<span class="sb">    var qstr  = window.location.search.substring(1);</span>
<span class="sb">    var pairs = qstr.split(&#39;&amp;&#39;);</span>
<span class="sb">    var ret = {}, i=0;</span>

<span class="sb">    for (i = 0; i &lt; pairs.length; i++) {</span>
<span class="sb">        var kv = pairs[i].split(&#39;=&#39;);</span>
<span class="sb">        ret[kv[0]]=kv[1];</span>
<span class="sb">    }</span>
<span class="sb">    return ret;</span>
<span class="sb">};</span>

<span class="sb">$(document).ready(function(){</span>

<span class="sb">    var curzip, curid;</span>
<span class="sb">    var params = getparams();</span>

<span class="sb">    // format the results, stick them in the div below the search form</span>
<span class="sb">    // update url to match state if curid is set</span>
<span class="sb">    function format_res(res_cities) {</span>
<span class="sb">        var resdiv = $(&#39;#res&#39;);</span>
<span class="sb">        var places = Object.keys(res_cities);</span>
<span class="sb">        var reshtml=&quot;&lt;h2&gt;Closest places to &quot; + $(&#39;#cstextbox&#39;).val() +&#39;&lt;/h2&gt;&#39;;;</span>
<span class="sb">        resdiv.html(&#39;&#39;);</span>

<span class="sb">        for (var i=0;i&lt;places.length;i++) {</span>
<span class="sb">            var j=0, place=places[i];</span>
<span class="sb">            var placeObj = res_cities[place];</span>
<span class="sb">            var zkeys = Object.keys(placeObj);</span>
<span class="sb">            var ziphtml=&#39;&#39;;</span>
<span class="sb">            var is_self=false; //flag if we are processing zip codes in the current city</span>

<span class="sb">            for(j=0;j&lt;zkeys.length;j++) {</span>
<span class="sb">                var zip=zkeys[j];</span>
<span class="sb">                if(zip == &#39;avgdist&#39;)</span>
<span class="sb">                    continue;</span>
<span class="sb">                if(zip == curzip ) {</span>
<span class="sb">                    is_self=true;</span>
<span class="sb">                    continue;</span>
<span class="sb">                }</span>
<span class="sb">                var zipObj = placeObj[zip];</span>
<span class="sb">                //console.log(zipObj);</span>
<span class="sb">                ziphtml+=&#39;&lt;a class=&quot;zip&quot; href=&quot;#&quot; data-zip=&quot;&#39; + zip + &#39;&quot; data-lat=&quot;&#39; + zipObj.lat + &#39;&quot; data-lon=&quot;&#39; +</span>
<span class="sb">                         zipObj.lon + &#39;&quot; data-id=&quot;&#39; + zipObj.id + &#39;&quot;&gt;&#39; + zip + &#39;(&#39; + zipObj.dist.toFixed(1) +</span>
<span class="sb">                         &#39;&amp;nbsp;&#39; + zipObj.heading + &#39;)&lt;/a&gt; &#39;;</span>
<span class="sb">            }</span>
<span class="sb">            if(ziphtml) {// skip self if only one zip.</span>
<span class="sb">                if(is_self)</span>
<span class="sb">                    reshtml += &#39;&lt;span&gt;&lt;h3&gt;Other zip codes in &lt;span class=&quot;place&quot;&gt;&#39; + place + &#39;&lt;/span&gt;&lt;/h3&gt;&#39;</span>
<span class="sb">                            + ziphtml + &quot;&lt;/span&gt;&quot;;</span>
<span class="sb">                else</span>
<span class="sb">                    reshtml += &#39;&lt;span&gt;&lt;h3&gt;&lt;span class=&quot;place&quot;&gt;&#39; + place + &#39;&lt;/span&gt; (&#39; +</span>
<span class="sb">                                parseFloat(placeObj.avgdist).toFixed(1)  +&#39; </span><span class="si">${</span><span class="nx">distvar</span><span class="si">}</span><span class="sb">.)&lt;/h3&gt;&#39; +</span>
<span class="sb">                                ziphtml + &quot;&lt;/span&gt;&quot;;</span>
<span class="sb">            }</span>
<span class="sb">        }</span>
<span class="sb">        resdiv.html(reshtml);</span>

<span class="sb">        if(curid){</span>
<span class="sb">            var nurl = window.location.origin + window.location.pathname + &#39;?id=&#39; + curid;</span>
<span class="sb">            window.history.pushState({},&#39;&#39;,nurl);</span>
<span class="sb">        }</span>
<span class="sb">    }</span>

<span class="sb">    // Use &#39;body&#39; and filter with class &#39;zip&#39; so the event will pick up not-yet-written content</span>
<span class="sb">    $(&#39;body&#39;).on(&#39;click&#39;,&#39;.zip&#39;,function(e) {</span>
<span class="sb">        //perform a new search on the zip code that was clicked.</span>
<span class="sb">        var t = $(this);</span>
<span class="sb">        var lat = t.attr(&#39;data-lat&#39;),</span>
<span class="sb">            lon=t.attr(&#39;data-lon&#39;),</span>
<span class="sb">            zip=t.attr(&#39;data-zip&#39;);</span>
<span class="sb">        var place = t.closest(&#39;span&#39;).find(&#39;.place&#39;).text();</span>

<span class="sb">        //curid is for the change of url in order to save the state.</span>
<span class="sb">        curid = t.attr(&#39;data-id&#39;);</span>

<span class="sb">        // recreate the place name with the zip code in it</span>
<span class="sb">        place = place.substring(0, place.length-2) +zip + &#39;, &#39; + place.substring(place.length-2, place.length);</span>
<span class="sb">        // put it in the search box</span>
<span class="sb">        $(&#39;#cstextbox&#39;).val(place);</span>

<span class="sb">        // fetch new list of closest cities and display</span>
<span class="sb">        $.getJSON(</span>
<span class="sb">            &quot;/apps/citysearch/ajaxres.json&quot;,</span>
<span class="sb">            {lat:lat, lon: lon},</span>
<span class="sb">            function(res) {</span>
<span class="sb">                curzip=zip;</span>
<span class="sb">                format_res(res.cities);</span>
<span class="sb">            }</span>
<span class="sb">        );</span>
<span class="sb">        return false; //don&#39;t actually go to the href in the clicked &lt;a&gt;</span>
<span class="sb">    });</span>

<span class="sb">    // the autocomplete plugin from  https://github.com/devbridge/jQuery-Autocomplete</span>
<span class="sb">    // jquery and plugin included from cloudflare in &lt;script src=&quot;xyz&quot;&gt; tags above.</span>
<span class="sb">    $(&#39;#cstextbox&#39;).autocomplete(</span>
<span class="sb">        {</span>
<span class="sb">            serviceUrl: &#39;/apps/citysearch/autocomp.json&#39;,</span>
<span class="sb">            minChars: 2,</span>
<span class="sb">            autoSelectFirst: true,</span>
<span class="sb">            showNoSuggestionNotice: true,</span>
<span class="sb">            onSelect: function(sel)</span>
<span class="sb">            {</span>
<span class="sb">                $.getJSON(</span>
<span class="sb">                    &quot;/apps/citysearch/ajaxres.json&quot;,</span>
<span class="sb">                    {lat:sel.latitude, lon: sel.longitude},</span>
<span class="sb">                    function(res) {</span>
<span class="sb">                        curzip = sel.zip;</span>
<span class="sb">                        curid = sel.id;</span>
<span class="sb">                        format_res(res.cities);</span>
<span class="sb">                    }</span>
<span class="sb">                );</span>
<span class="sb">            }</span>
<span class="sb">        }</span>
<span class="sb">    );</span>

<span class="sb">    // prevent form submission - all results are already in the autocomplete</span>
<span class="sb">    $(&#39;#cstextbox&#39;).on(&#39;keypress&#39;, function(e){</span>
<span class="sb">        var key = e.charCode || e.keyCode || 0;</span>
<span class="sb">        if (key == 13) {</span>
<span class="sb">            e.preventDefault();</span>
<span class="sb">            return false;</span>
<span class="sb">        }</span>
<span class="sb">    });</span>

<span class="sb">    function refresh(id) {</span>
<span class="sb">        $.getJSON(</span>
<span class="sb">            &quot;/apps/citysearch/ajaxres.json&quot;,</span>
<span class="sb">            {id:params.id},</span>
<span class="sb">            function(res) {</span>
<span class="sb">                curzip = res.zip;</span>
<span class="sb">                $(&#39;#cstextbox&#39;).val(res.place);</span>
<span class="sb">                //no curid necessary here</span>
<span class="sb">                format_res(res.cities);</span>
<span class="sb">            }</span>
<span class="sb">        );</span>
<span class="sb">    }</span>
<span class="sb">    // if we refresh the page, then reload the content</span>
<span class="sb">    if(params.id) {</span>
<span class="sb">        refresh(params.id);</span>
<span class="sb">    }</span>

<span class="sb">    window.onpopstate = function(event) {</span>
<span class="sb">        // url has changed, but page was not reloaded</span>
<span class="sb">        params = getparams();</span>
<span class="sb">        curid=false;</span>
<span class="sb">        if(params.id)</span>
<span class="sb">            refresh(params.id);</span>
<span class="sb">        else {</span>
<span class="sb">            $(&#39;#cstextbox&#39;).val(&#39;&#39;);</span>
<span class="sb">            $(&#39;#res&#39;).html(&#39;&#39;);</span>
<span class="sb">        }</span>
<span class="sb">    };</span>

<span class="sb">});</span>
<span class="sb">`</span><span class="p">;</span>


<span class="c1">// page is defined once upon script load here rather than upon each request in</span>
<span class="c1">// htmlpage() below.</span>
<span class="kd">var</span> <span class="nx">page</span><span class="o">=</span><span class="sb">`&lt;!DOCTYPE HTML&gt;</span>
<span class="sb">&lt;html&gt;</span>
<span class="sb">    &lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="sb">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="sb">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="sb">    &lt;style&gt;</span>
<span class="sb">        body,h1,h2,h3,h4,h5,h6 {font-family: &quot;Varela Round&quot;, Sans-Serif;}</span>
<span class="sb">        .autocomplete-suggestions {</span>
<span class="sb">            border: 1px solid #999;</span>
<span class="sb">            background: #FFF;</span>
<span class="sb">            overflow: auto;</span>
<span class="sb">            width: auto !important;</span>
<span class="sb">            padding-right:5px;</span>
<span class="sb">        }</span>
<span class="sb">        .autocomplete-suggestion {</span>
<span class="sb">            padding: 2px 5px;</span>
<span class="sb">            white-space: nowrap;</span>
<span class="sb">            overflow: hidden;</span>
<span class="sb">        }</span>
<span class="sb">        .autocomplete-suggestions strong {</span>
<span class="sb">            font-weight: normal;</span>
<span class="sb">            color: #3399FF;</span>
<span class="sb">        }</span>
<span class="sb">        .autocomplete-group strong {</span>
<span class="sb">            display: block;</span>
<span class="sb">            border-bottom: 1px solid #000;</span>
<span class="sb">        }</span>
<span class="sb">        .autocomplete-selected { background: #F0F0F0; }</span>
<span class="sb">        .autocomplete-group { padding: 2px 5px; }</span>
<span class="sb">        .zip { display: inline-block; width:140px;}</span>
<span class="sb">        #main {</span>
<span class="sb">            background-color: white;</span>
<span class="sb">            margin: auto;</span>
<span class="sb">            min-height: 300px;</span>
<span class="sb">            width: 600px;</span>
<span class="sb">        }</span>
<span class="sb">        #idiv {</span>
<span class="sb">            width:500px;</span>
<span class="sb">            height:39px;</span>
<span class="sb">            border-bottom: lightGray 1px solid;</span>
<span class="sb">            padding:15px 0px 15px 0px;</span>
<span class="sb">        }</span>
<span class="sb">        #cstextbox {</span>
<span class="sb">            min-width:150px;</span>
<span class="sb">            width:100%;</span>
<span class="sb">            height:30px;</span>
<span class="sb">            font:normal 18px arial,sans-serif;</span>
<span class="sb">            padding: 1px 3px;</span>
<span class="sb">            border: 2px solid #ccc;</span>
<span class="sb">            box-sizing: border-box;</span>
<span class="sb">        }</span>
<span class="sb">    &lt;/style&gt;</span>
<span class="sb">    &lt;title&gt;City Search Tutorial&lt;/title&gt;</span>
<span class="sb">    &lt;/head&gt;</span>
<span class="sb">    &lt;body&gt;</span>
<span class="sb">    &lt;div id=&quot;main&quot;&gt;</span>
<span class="sb">      &lt;form id=&quot;mf&quot;&gt;</span>
<span class="sb">          &lt;div id=&quot;idiv&quot;&gt;</span>
<span class="sb">              &lt;input type=&quot;text&quot; id=&quot;cstextbox&quot; name=&quot;q&quot; value=&quot;&quot; placeholder=&quot;Search for a city&quot;&gt;</span>
<span class="sb">          &lt;/div&gt;</span>
<span class="sb">      &lt;/form&gt;</span>
<span class="sb">      &lt;div id=&quot;res&quot;&gt;&lt;/div&gt;</span>
<span class="sb">      &lt;/body&gt;</span>
<span class="sb">      &lt;script&gt;</span>
<span class="sb">          </span><span class="si">${</span><span class="nx">client_script</span><span class="si">}</span><span class="sb"></span>
<span class="sb">      &lt;/script&gt;</span>
<span class="sb">&lt;/html&gt;`</span><span class="p">;</span>



<span class="kd">function</span> <span class="nx">htmlpage</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// just return the html.</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">html</span><span class="o">:</span><span class="nx">page</span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">ajaxres</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">autocomp</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>


<span class="c1">// url to function mapping</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;/&quot;</span><span class="o">:</span>               <span class="nx">htmlpage</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/</span>
    <span class="s2">&quot;/index.html&quot;</span><span class="o">:</span>     <span class="nx">htmlpage</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/index.html</span>
    <span class="s2">&quot;/autocomp.json&quot;</span><span class="o">:</span>  <span class="nx">autocomp</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/autocomp.json</span>
    <span class="s2">&quot;/ajaxres.json&quot;</span><span class="o">:</span>   <span class="nx">ajaxres</span>    <span class="c1">//http://localhost:8088/apps/citysearch/ajaxres.json</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As mentioned before, we are going to concentrate on the server side
functionality, so explaining the client-side JavaScript functionality
is beyond the scope of this tutorial.  Instead, know that the script expects
the following:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// autocomp() results must be formatted as such:</span>
<span class="p">{</span>
    <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;Vaulion, Canton de Vaud, 1325, CH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;6233eaf65bd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="o">:</span><span class="mf">46.6848</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="o">:</span><span class="mf">6.3832</span><span class="p">,</span>
            <span class="s2">&quot;zip&quot;</span><span class="o">:</span><span class="s2">&quot;1325&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;Vallorbe, Canton de Vaud, 1337, CH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;6233eaf65c6&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="o">:</span><span class="mf">46.7078</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="o">:</span><span class="mf">6.3714</span><span class="p">,</span>
            <span class="s2">&quot;zip&quot;</span><span class="o">:</span><span class="s2">&quot;1337&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;Valeyres-sous-Rances, Canton de Vaud, 1358, CH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;6233eaf6608&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="o">:</span><span class="mf">46.7482</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="o">:</span><span class="mf">6.5354</span><span class="p">,</span>
            <span class="s2">&quot;zip&quot;</span><span class="o">:</span><span class="s2">&quot;1358&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;value&quot;</span><span class="o">:</span><span class="s2">&quot;Valeyres-sous-Ursins, Canton de Vaud, 1412, CH&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;6233eaf663b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="o">:</span><span class="mf">46.7453</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="o">:</span><span class="mf">6.6533</span><span class="p">,</span>
            <span class="s2">&quot;zip&quot;</span><span class="o">:</span><span class="s2">&quot;1412&quot;</span>
        <span class="p">},</span>
        <span class="c1">// ...</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="c1">// ajaxres() results must be formatted as such:</span>
<span class="p">{</span>
    <span class="s2">&quot;cities&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;Dixon, California, US&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;95620&quot;</span><span class="o">:</span><span class="p">{</span>
                <span class="s2">&quot;dist&quot;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="o">:-</span><span class="mf">121.8088</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="o">:</span><span class="mf">38.4403</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;6233ef9f79d&quot;</span><span class="p">,</span>
                <span class="s2">&quot;heading&quot;</span><span class="o">:</span><span class="s2">&quot;N&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;avgdist&quot;</span><span class="o">:</span><span class="mi">0</span>
        <span class="p">},</span>
        <span class="s2">&quot;Davis, California, US&quot;</span><span class="o">:</span><span class="p">{</span>
            <span class="s2">&quot;95616&quot;</span><span class="o">:</span><span class="p">{</span>
                <span class="s2">&quot;dist&quot;</span><span class="o">:</span><span class="mf">13.892710766687838</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="o">:-</span><span class="mf">121.7418</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="o">:</span><span class="mf">38.5538</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;6233ef9fa43&quot;</span><span class="p">,</span>
                <span class="s2">&quot;heading&quot;</span><span class="o">:</span><span class="s2">&quot;NNE&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;95617&quot;</span><span class="o">:</span><span class="p">{</span>
                <span class="s2">&quot;dist&quot;</span><span class="o">:</span><span class="mf">14.13145261199491</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="o">:-</span><span class="mf">121.7253</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="o">:</span><span class="mf">38.5494</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;6233ef9fa46&quot;</span><span class="p">,</span>
                <span class="s2">&quot;heading&quot;</span><span class="o">:</span><span class="s2">&quot;NNE&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;95618&quot;</span><span class="o">:</span><span class="p">{</span>
                <span class="s2">&quot;dist&quot;</span><span class="o">:</span><span class="mf">13.052788618796216</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="o">:-</span><span class="mf">121.7405</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="o">:</span><span class="mf">38.5449</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;6233ef9fa49&quot;</span><span class="p">,</span>
                <span class="s2">&quot;heading&quot;</span><span class="o">:</span><span class="s2">&quot;NNE&quot;</span>
            <span class="p">},</span>
            <span class="s2">&quot;avgdist&quot;</span><span class="o">:</span><span class="mf">13.692317332492989</span>
        <span class="p">},</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
    <span class="c1">// included if lookup by id:</span>
    <span class="s2">&quot;place&quot;</span><span class="o">:</span> <span class="s2">&quot;Dixon, California, 95620, US&quot;</span><span class="p">,</span>
    <span class="s2">&quot;zip&quot;</span><span class="o">:</span> <span class="s2">&quot;95620&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Also added is the variable <code class="docutils literal notranslate"><span class="pre">useKilometers</span></code>, which will be used both
client-side and for formatting the JSON results.</p>
</div>
<div class="section" id="formatting-auto-complete-results">
<h3>Formatting Auto-Complete Results<a class="headerlink" href="#formatting-auto-complete-results" title="Permalink to this headline">¶</a></h3>
<p>First step will be to construct our SQL statement and query in order
to get a list of cities that are closest to a city or lat/lon requested.</p>
<p>When we made our Fulltext index on our table, we used the virtual field
<code class="docutils literal notranslate"><span class="pre">place_name\postal_code\admin_name1\admin_code1\country_code\admin_name2\admin_code2\admin_name3\admin_code3</span></code>
in order to concatenate all the text we might want to use to look up a city.</p>
<p>So to find a city, let’s construct a SQL statement which will return cities
that match a query</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span>SELECT
place_name +&#39;, &#39; + admin_name1 + &#39;, &#39; + postal_code + &#39;, &#39; + country_code value,
id, latitude, longitude, postal_code zip
FROM geonames WHERE
place_name\postal_code\admin_name1\admin_code1\country_code\admin_name2\admin_code2\admin_name3\admin_code3
LIKEP ?;
</pre></div>
</div>
<p>Taking it line by line:</p>
<p><code class="docutils literal notranslate"><span class="pre">SELECT</span></code> - We are looking up and returning rows in the table.</p>
<p><code class="docutils literal notranslate"><span class="pre">place_name</span> <span class="pre">+',</span> <span class="pre">'</span> <span class="pre">+</span> <span class="pre">admin_name1</span> <span class="pre">+</span> <span class="pre">',</span> <span class="pre">'</span> <span class="pre">+</span> <span class="pre">postal_code</span> <span class="pre">+</span> <span class="pre">',</span> <span class="pre">'</span> <span class="pre">+</span> <span class="pre">country_code</span> <span class="pre">value,</span></code>
- We are formatting several column so it will return, e.g.,
<code class="docutils literal notranslate"><span class="pre">San</span> <span class="pre">Francisco,</span> <span class="pre">CA,</span> <span class="pre">94143,</span> <span class="pre">US</span></code> and naming the string <code class="docutils literal notranslate"><span class="pre">value</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">id,</span> <span class="pre">latitude,</span> <span class="pre">longitude,</span> <span class="pre">postal_code</span> <span class="pre">zip</span></code> - Other columns we need.</p>
<p><code class="docutils literal notranslate"><span class="pre">FROM</span> <span class="pre">geonames</span> <span class="pre">WHERE</span></code> - The name of the table, and <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> for the
search on the next line.</p>
<p><code class="docutils literal notranslate"><span class="pre">place_name\...\admin_name3\admin_code3</span></code>
- Specifying the virtual field upon which the Fulltext index is build.</p>
<p><code class="docutils literal notranslate"><span class="pre">LIKEP</span> <span class="pre">?</span></code> - <code class="docutils literal notranslate"><span class="pre">likep</span></code> signifies a Fulltext search where word positions are
significant.  This will be your most used type of <code class="docutils literal notranslate"><span class="pre">like</span></code> search for normal
Fulltext queries.  The <code class="docutils literal notranslate"><span class="pre">?</span></code> corresponds to a variable we will give
<code class="docutils literal notranslate"><span class="pre">sql.exec()</span></code>, as explained below.</p>
<p>So lets start writing our <code class="docutils literal notranslate"><span class="pre">autocomp()</span></code> function, using this query:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="cm">/* autocomp() results must be formatted as such:</span>
<span class="cm">{</span>
<span class="cm">    &quot;suggestions&quot;: [</span>
<span class="cm">        {&quot;value&quot;:&quot;Vaulion, Canton de Vaud, 1325, CH&quot;,&quot;id&quot;:&quot;6233eaf65bd&quot;,&quot;latitude&quot;:46.6848,&quot;longitude&quot;:6.3832,&quot;zip&quot;:&quot;1325&quot;},</span>
<span class="cm">        {&quot;value&quot;:&quot;Vallorbe, Canton de Vaud, 1337, CH&quot;,&quot;id&quot;:&quot;6233eaf65c6&quot;,&quot;latitude&quot;:46.7078,&quot;longitude&quot;:6.3714,&quot;zip&quot;:&quot;1337&quot;},</span>
<span class="cm">        {&quot;value&quot;:&quot;Valeyres-sous-Rances, Canton de Vaud, 1358, CH&quot;,&quot;id&quot;:&quot;6233eaf6608&quot;,&quot;latitude&quot;:46.7482,&quot;longitude&quot;:6.5354,&quot;zip&quot;:&quot;1358&quot;},</span>
<span class="cm">        {&quot;value&quot;:&quot;Valeyres-sous-Ursins, Canton de Vaud, 1412, CH&quot;,&quot;id&quot;:&quot;6233eaf663b&quot;,&quot;latitude&quot;:46.7453,&quot;longitude&quot;:6.6533,&quot;zip&quot;:&quot;1412&quot;},</span>
<span class="cm">        ...</span>
<span class="cm">    ]</span>
<span class="cm">}</span>
<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">autocomp</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>

    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`SELECT</span>
<span class="sb">        place_name +&#39;, &#39; + admin_name1 + &#39;, &#39; + postal_code + &#39;, &#39; + country_code value,</span>
<span class="sb">        id, latitude, longitude, postal_code zip</span>
<span class="sb">        FROM geonames WHERE</span>
<span class="sb">        place_name\\postal_code\\admin_name1\\admin_code1\\country_code\\admin_name2\\admin_code2\\admin_name3\\admin_code3</span>
<span class="sb">        LIKEP ?;`</span><span class="p">,</span>
        <span class="p">[</span><span class="nx">q</span><span class="p">]</span> <span class="c1">// corresponding to the &quot;?&quot; in &quot;LIKEP ?&quot;</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">}};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Indeed this will return JSON formatted results in the format needed by the
client-side JavaScript.  Unfortunately, it will not match cities unless the
query contains full words.  Further, if jquery.autocomplete doesn’t get
results for, e.g., <code class="docutils literal notranslate"><span class="pre">ber</span></code>, it will not look for <code class="docutils literal notranslate"><span class="pre">berk</span></code>, making our search pretty
much non-functional.</p>
<p>We would like a query like <code class="docutils literal notranslate"><span class="pre">ber</span></code> to match <code class="docutils literal notranslate"><span class="pre">Berkeley</span></code> and all other
results that have words beginning with <code class="docutils literal notranslate"><span class="pre">ber</span></code>.  So lets add a <code class="docutils literal notranslate"><span class="pre">*</span></code> to the
last word in our search.  However, note that we only want to do that if the
last partial word is at least two characters long, since looking up every
city starting with <code class="docutils literal notranslate"><span class="pre">b*</span></code> would produce too many results to be meaningful.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="cm">/* autocomp() results must be formatted as such:</span>
<span class="cm">{</span>
<span class="cm">    &quot;suggestions&quot;: [</span>
<span class="cm">        {&quot;value&quot;:&quot;Vaulion, Canton de Vaud, 1325, CH&quot;,&quot;id&quot;:&quot;6233eaf65bd&quot;,&quot;latitude&quot;:46.6848,&quot;longitude&quot;:6.3832,&quot;zip&quot;:&quot;1325&quot;},</span>
<span class="cm">        {&quot;value&quot;:&quot;Vallorbe, Canton de Vaud, 1337, CH&quot;,&quot;id&quot;:&quot;6233eaf65c6&quot;,&quot;latitude&quot;:46.7078,&quot;longitude&quot;:6.3714,&quot;zip&quot;:&quot;1337&quot;},</span>
<span class="cm">        {&quot;value&quot;:&quot;Valeyres-sous-Rances, Canton de Vaud, 1358, CH&quot;,&quot;id&quot;:&quot;6233eaf6608&quot;,&quot;latitude&quot;:46.7482,&quot;longitude&quot;:6.5354,&quot;zip&quot;:&quot;1358&quot;},</span>
<span class="cm">        {&quot;value&quot;:&quot;Valeyres-sous-Ursins, Canton de Vaud, 1412, CH&quot;,&quot;id&quot;:&quot;6233eaf663b&quot;,&quot;latitude&quot;:46.7453,&quot;longitude&quot;:6.6533,&quot;zip&quot;:&quot;1412&quot;},</span>
<span class="cm">        ...</span>
<span class="cm">    ]</span>
<span class="cm">}</span>
<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">autocomp</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>

    <span class="c1">// ignore one character partial words</span>

    <span class="c1">// remove any spaces at the beginning of q</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s+/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>

    <span class="c1">// if query is only one char, return an empty set</span>
    <span class="c1">//   (even though client-side autocomplete is set to 2 char min)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="p">[]}}</span>

    <span class="c1">// we will need at least two chars in our last word</span>
    <span class="c1">// since it will get a &#39;*&#39; wildcard added to it</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ \S$/</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">);</span>


    <span class="c1">// if last character is not a space, add wildcard</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nx">q</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>

    <span class="c1">// perform a text search on the words or partial words we have, and return a list of best matching locations</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`SELECT</span>
<span class="sb">        place_name +&#39;, &#39; + admin_name1 + &#39;, &#39; + postal_code + &#39;, &#39; + country_code value,</span>
<span class="sb">        id, latitude, longitude, postal_code zip</span>
<span class="sb">        FROM geonames WHERE</span>
<span class="sb">        place_name\\postal_code\\admin_name1\\admin_code1\\country_code\\admin_name2\\admin_code2\\admin_name3\\admin_code3</span>
<span class="sb">        LIKEP ?;`</span><span class="p">,</span>
        <span class="p">[</span><span class="nx">q</span><span class="p">]</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">}};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using the example of <code class="docutils literal notranslate"><span class="pre">be</span></code> as a search, our script will add a <code class="docutils literal notranslate"><span class="pre">*</span></code> to it
and pass it to <code class="docutils literal notranslate"><span class="pre">sql.exec()</span></code>.</p>
<p>Texis’ Fulltext search will first search its index for all words beginning
with <code class="docutils literal notranslate"><span class="pre">be</span></code> and add them to the query.  Since this could potentially be
thousands of words added to our query, we need to make a few adjustments to
the default limits.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
    <span class="s1">&#39;qMaxWords&#39;</span>    <span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1">// allow query and sets to be larger than normal for &#39;*&#39; wildcard searches</span>
    <span class="s1">&#39;qMaxSetWords&#39;</span> <span class="o">:</span> <span class="mi">5000</span>   <span class="c1">// see https://rampart.dev/docs/sql-set.html#qmaxsetwords</span>
                            <span class="c1">// and https://rampart.dev/docs/sql-set.html#qmaxwords .</span>
<span class="p">});</span>
</pre></div>
</div>
<p>For our next tweak – normally we want to return the best results for a given
query, even if every word in the query is not match in any single document.
However, in this case, we want to handle things a bit differently.  Our
objective is to narrow down our list of possible matches as we type.  So we
want to make sure that we do not return rows unless they match every term
given.  So we will set <code class="docutils literal notranslate"><span class="pre">likepAllmatch</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
    <span class="s1">&#39;likepAllmatch&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">// match every word or partial word</span>
    <span class="s1">&#39;qMaxWords&#39;</span>    <span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1">// allow query and sets to be larger than normal for &#39;*&#39; wildcard searches</span>
    <span class="s1">&#39;qMaxSetWords&#39;</span> <span class="o">:</span> <span class="mi">5000</span>   <span class="c1">// see https://rampart.dev/docs/sql-set.html#qmaxsetwords</span>
                            <span class="c1">// and https://rampart.dev/docs/sql-set.html#qmaxwords .</span>
<span class="p">});</span>
</pre></div>
</div>
<p>Our completed function now looks like this:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="cm">/* autocomp() results must be formatted as such:</span>
<span class="cm">{</span>
<span class="cm">    &quot;suggestions&quot;: [</span>
<span class="cm">        {&quot;value&quot;:&quot;Vaulion, Canton de Vaud, 1325, CH&quot;,&quot;id&quot;:&quot;6233eaf65bd&quot;,&quot;latitude&quot;:46.6848,&quot;longitude&quot;:6.3832,&quot;zip&quot;:&quot;1325&quot;},</span>
<span class="cm">        {&quot;value&quot;:&quot;Vallorbe, Canton de Vaud, 1337, CH&quot;,&quot;id&quot;:&quot;6233eaf65c6&quot;,&quot;latitude&quot;:46.7078,&quot;longitude&quot;:6.3714,&quot;zip&quot;:&quot;1337&quot;},</span>
<span class="cm">        {&quot;value&quot;:&quot;Valeyres-sous-Rances, Canton de Vaud, 1358, CH&quot;,&quot;id&quot;:&quot;6233eaf6608&quot;,&quot;latitude&quot;:46.7482,&quot;longitude&quot;:6.5354,&quot;zip&quot;:&quot;1358&quot;},</span>
<span class="cm">        {&quot;value&quot;:&quot;Valeyres-sous-Ursins, Canton de Vaud, 1412, CH&quot;,&quot;id&quot;:&quot;6233eaf663b&quot;,&quot;latitude&quot;:46.7453,&quot;longitude&quot;:6.6533,&quot;zip&quot;:&quot;1412&quot;},</span>
<span class="cm">        ...</span>
<span class="cm">    ]</span>
<span class="cm">}</span>
<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">autocomp</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>

    <span class="c1">// ignore one character partial words</span>

    <span class="c1">// remove any spaces at the beginning of q</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s+/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>

    <span class="c1">// if query is only one char, return an empty set</span>
    <span class="c1">//   (even though client-side autocomplete is set to 2 char min)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="p">[]}}</span>

    <span class="c1">// we will need at least two chars in our last word</span>
    <span class="c1">// since it will get a &#39;*&#39; wildcard added to it</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ \S$/</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">);</span>


    <span class="c1">// if last character is not a space, add wildcard</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nx">q</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>

    <span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="s1">&#39;likepAllmatch&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">// match every word or partial word</span>
        <span class="s1">&#39;qMaxWords&#39;</span>    <span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1">// allow query and sets to be larger than normal for &#39;*&#39; wildcard searches</span>
        <span class="s1">&#39;qMaxSetWords&#39;</span> <span class="o">:</span> <span class="mi">5000</span>   <span class="c1">// see https://rampart.dev/docs/sql-set.html#qmaxsetwords</span>
                                <span class="c1">// and https://rampart.dev/docs/sql-set.html#qmaxwords .</span>
    <span class="p">});</span>

    <span class="c1">// perform a text search on the words or partial words we have, and return a list of best matching locations</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`SELECT</span>
<span class="sb">        place_name +&#39;, &#39; + admin_name1 + &#39;, &#39; + postal_code + &#39;, &#39; + country_code value,</span>
<span class="sb">        id, latitude, longitude, postal_code zip</span>
<span class="sb">        FROM geonames WHERE</span>
<span class="sb">        place_name\\postal_code\\admin_name1\\admin_code1\\country_code\\admin_name2\\admin_code2\\admin_name3\\admin_code3</span>
<span class="sb">        LIKEP ?;`</span><span class="p">,</span>
        <span class="p">[</span><span class="nx">q</span><span class="p">]</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">}};</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="finding-and-formatting-nearest-cities">
<h3>Finding and Formatting Nearest Cities<a class="headerlink" href="#finding-and-formatting-nearest-cities" title="Permalink to this headline">¶</a></h3>
<p>In the <code class="docutils literal notranslate"><span class="pre">ajaxres()</span></code> function, we will return a set of results
corresponding to the closest cities to a given city or lat/lon query.</p>
<p>To do so, we will use Texis’ built-in SQL server function
<a class="reference internal" href="sql-server-funcs.html#latlon2geocode-latlon2geocodearea"><span class="std std-ref">latlon2geocodearea</span></a>.
We also want to retrieve how far away the location is from the given
lat/lon (using <a class="reference internal" href="sql-server-funcs.html#distlatlon"><span class="std std-ref">distlatlon</span></a> function), as
well as which compass direction the location is from the given lat/lon
(using the <a class="reference internal" href="sql-server-funcs.html#azimuthlatlon"><span class="std std-ref">azimuthlatlon</span></a> and
<a class="reference internal" href="sql-server-funcs.html#azimuth2compass"><span class="std std-ref">azimuth2compass</span></a> functions).</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
<span class="n">place_name</span> <span class="o">+</span><span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">admin_name1</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="n">country_code</span> <span class="n">place</span><span class="p">,</span>
<span class="n">id</span><span class="p">,</span> <span class="n">postal_code</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span>
<span class="n">DISTLATLON</span><span class="p">(</span><span class="o">?</span><span class="n">lat</span><span class="p">,</span> <span class="o">?</span><span class="n">lon</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">)</span> <span class="n">dist</span><span class="p">,</span>
<span class="n">AZIMUTH2COMPASS</span><span class="p">(</span> <span class="n">AZIMUTHLATLON</span><span class="p">(</span><span class="o">?</span><span class="n">lat</span><span class="p">,</span> <span class="o">?</span><span class="n">lon</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">),</span> <span class="mi">3</span> <span class="p">)</span> <span class="n">heading</span>
<span class="k">FROM</span> <span class="n">geonames</span> <span class="k">WHERE</span>
<span class="n">geocode</span> <span class="k">BETWEEN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">LATLON2GEOCODEAREA</span><span class="p">(</span><span class="o">?</span><span class="n">lat</span><span class="p">,</span> <span class="o">?</span><span class="n">lon</span><span class="p">,</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span><span class="p">))</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="mi">6</span> <span class="k">ASC</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SELECT</span></code> - We are looking up and returning rows in the table.</p>
<p><code class="docutils literal notranslate"><span class="pre">place_name</span> <span class="pre">+',</span> <span class="pre">'</span> <span class="pre">+</span> <span class="pre">admin_name1</span> <span class="pre">+</span> <span class="pre">',</span> <span class="pre">'</span> <span class="pre">+</span> <span class="pre">country_code</span> <span class="pre">place,</span></code>
- We are formatting several column so it will return, e.g.,
<code class="docutils literal notranslate"><span class="pre">San</span> <span class="pre">Francisco,</span> <span class="pre">CA,</span> <span class="pre">US</span></code> and naming the string <code class="docutils literal notranslate"><span class="pre">place</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">id,</span> <span class="pre">postal_code,</span> <span class="pre">latitude,</span> <span class="pre">longitude</span></code> - Other columns we need.</p>
<p><code class="docutils literal notranslate"><span class="pre">DISTLATLON(?lat,</span> <span class="pre">?lon,</span> <span class="pre">latitude,</span> <span class="pre">longitude)</span> <span class="pre">dist,</span></code> - Calculate the
distance between the given lat/lon and the <code class="docutils literal notranslate"><span class="pre">latitude</span></code> and <code class="docutils literal notranslate"><span class="pre">longitude</span></code>
columns of the selected row.  Name the result <code class="docutils literal notranslate"><span class="pre">dist</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">AZIMUTH2COMPASS(</span> <span class="pre">AZIMUTHLATLON(?lat,</span> <span class="pre">?lon,</span> <span class="pre">latitude,</span> <span class="pre">longitude),</span> <span class="pre">3</span> <span class="pre">)</span> <span class="pre">heading</span></code> -
First calculate the compass direction (azimuth) from lat/lon to the row’s
<code class="docutils literal notranslate"><span class="pre">latitude</span></code> and <code class="docutils literal notranslate"><span class="pre">longitude</span></code> columns.  Then convert that to a more friendly 2 or 3
letter direction abbreviation (i.e. - <code class="docutils literal notranslate"><span class="pre">SE</span></code>, <code class="docutils literal notranslate"><span class="pre">NW</span></code>, <code class="docutils literal notranslate"><span class="pre">ENE</span></code>).</p>
<p><code class="docutils literal notranslate"><span class="pre">FROM</span> <span class="pre">geonames</span> <span class="pre">WHERE</span></code> - The name of the table, and <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> for the
search on the next line.</p>
<p><code class="docutils literal notranslate"><span class="pre">geocode</span> <span class="pre">BETWEEN</span> <span class="pre">(SELECT</span> <span class="pre">LATLON2GEOCODEAREA(?lat,</span> <span class="pre">?lon,</span> <span class="pre">1.0))</span></code> - We use
our computed <code class="docutils literal notranslate"><span class="pre">geocode</span></code> field to limit returned rows to those that are
within one (<code class="docutils literal notranslate"><span class="pre">1.0</span></code>) degrees of our given lat/lon (see
<a class="reference internal" href="sql-server-funcs.html#latlon2geocode-latlon2geocodearea"><span class="std std-ref">latlon2geocodearea</span></a>
for precise definition of bounding box search).  This will give us a search
radius (box center to side) of about 69 miles (111 km) at the equator,
decreasing in width as we approach the poles.</p>
<p><code class="docutils literal notranslate"><span class="pre">ORDER</span> <span class="pre">BY</span> <span class="pre">6</span> <span class="pre">ASC</span></code> - we will order by the sixth selected column (in this
case – <code class="docutils literal notranslate"><span class="pre">dist</span></code>).</p>
<p>So lets start writing our <code class="docutils literal notranslate"><span class="pre">ajaxres()</span></code> function, using this query:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">ajaxres</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">lon</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">lon</span><span class="p">,</span> <span class="nx">lat</span><span class="o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">lat</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">lon</span> <span class="o">||</span> <span class="o">!</span><span class="nx">lat</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span><span class="p">{}};</span>

    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`SELECT</span>
<span class="sb">        place_name +&#39;, &#39; + admin_name1 + &#39;, &#39; + country_code place,</span>
<span class="sb">        id, postal_code, latitude, longitude,</span>
<span class="sb">        DISTLATLON(?lat, ?lon, latitude, longitude) dist,</span>
<span class="sb">        AZIMUTH2COMPASS( AZIMUTHLATLON(?lat, ?lon, latitude, longitude), 3 ) heading</span>
<span class="sb">        FROM geonames WHERE</span>
<span class="sb">        geocode BETWEEN (SELECT LATLON2GEOCODEAREA(?lat, ?lon, 1.0))</span>
<span class="sb">        ORDER BY 6 ASC;`</span><span class="p">,</span>
        <span class="p">{</span><span class="nx">lat</span><span class="o">:</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="o">:</span><span class="nx">lon</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">maxRows</span><span class="o">:</span> <span class="mi">100</span> <span class="p">}</span>
    <span class="p">);</span>
</pre></div>
</div>
<p>Here we use the <span class="green">Object</span> <code class="docutils literal notranslate"><span class="pre">{lat:lat,</span> <span class="pre">lon:lon}</span></code> to fill in the <code class="docutils literal notranslate"><span class="pre">?lat</span></code> and
<code class="docutils literal notranslate"><span class="pre">?lon</span></code> in the SQL query.  In this case it is easier than the using <code class="docutils literal notranslate"><span class="pre">?,?</span></code>
style and providing an <span class="green">Array</span> since the same lat/lon values are
being use multiple times.</p>
<p>We also provide the <span class="green">Object</span> <code class="docutils literal notranslate"><span class="pre">{maxRows:</span> <span class="pre">100}</span></code> to override the default of ten
rows.</p>
<p>This will return something similar to:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="nx">res</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;columns&quot;</span><span class="o">:</span><span class="p">[</span><span class="s2">&quot;place&quot;</span><span class="p">,</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="s2">&quot;postal_code&quot;</span><span class="p">,</span><span class="s2">&quot;latitude&quot;</span><span class="p">,</span><span class="s2">&quot;longitude&quot;</span><span class="p">,</span><span class="s2">&quot;dist&quot;</span><span class="p">,</span><span class="s2">&quot;heading&quot;</span><span class="p">],</span>
    <span class="s2">&quot;rows&quot;</span><span class="o">:</span><span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;place&quot;</span><span class="o">:</span><span class="s2">&quot;Dixon, California, US&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;6233ef9f79d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;postal_code&quot;</span><span class="o">:</span><span class="s2">&quot;95620&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="o">:</span><span class="mf">38.4403</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="o">:-</span><span class="mf">121.8088</span><span class="p">,</span>
            <span class="s2">&quot;dist&quot;</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;heading&quot;</span><span class="o">:</span><span class="s2">&quot;N&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;place&quot;</span><span class="o">:</span><span class="s2">&quot;Davis, California, US&quot;</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="s2">&quot;6233ef9fa49&quot;</span><span class="p">,</span>
            <span class="s2">&quot;postal_code&quot;</span><span class="o">:</span><span class="s2">&quot;95618&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latitude&quot;</span><span class="o">:</span><span class="mf">38.5449</span><span class="p">,</span>
            <span class="s2">&quot;longitude&quot;</span><span class="o">:-</span><span class="mf">121.7405</span><span class="p">,</span>
            <span class="s2">&quot;dist&quot;</span><span class="o">:</span><span class="mf">8.110646984972856</span><span class="p">,</span>
            <span class="s2">&quot;heading&quot;</span><span class="o">:</span><span class="s2">&quot;NNE&quot;</span>
        <span class="p">},</span>
        <span class="c1">// ...</span>
    <span class="p">],</span>
    <span class="s2">&quot;rowCount&quot;</span><span class="o">:</span><span class="mi">100</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That’s nice, but not in the format that we need.  We need to group results by
<code class="docutils literal notranslate"><span class="pre">place</span></code> and format the result as needed by the client-side JavaScript.</p>
<p>So let’s write a function to do that:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">distconv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="nx">useKilometers</span><span class="p">)</span>
    <span class="nx">distconv</span><span class="o">=</span><span class="mf">1.60934</span>

<span class="c1">// reorganize our data for easy handling client side.</span>
<span class="kd">function</span> <span class="nx">reorg_places</span><span class="p">(</span><span class="nx">places</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">ret</span><span class="o">=</span><span class="p">{};</span>
    <span class="cm">/* group by city, with entries for distance for each zip code */</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">places</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">places</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">ret</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">place</span><span class="p">])</span>
            <span class="nx">ret</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">place</span><span class="p">]</span><span class="o">=</span><span class="p">{};</span>
        <span class="nx">ret</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">place</span><span class="p">][</span><span class="nx">p</span><span class="p">.</span><span class="nx">postal_code</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">dist</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">dist</span> <span class="o">*</span> <span class="nx">distconv</span><span class="p">,</span>
            <span class="nx">lon</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">longitude</span><span class="p">,</span>
            <span class="nx">lat</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
            <span class="nx">heading</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">heading</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="c1">// calc average distance</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">placeName</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">placeObj</span> <span class="o">=</span> <span class="nx">ret</span><span class="p">[</span><span class="nx">placeName</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">zkeys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">placeObj</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">avg</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">j</span><span class="o">&lt;</span><span class="nx">zkeys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">zkey</span> <span class="o">=</span> <span class="nx">zkeys</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
            <span class="nx">avg</span> <span class="o">+=</span> <span class="nx">placeObj</span><span class="p">[</span><span class="nx">zkey</span><span class="p">].</span><span class="nx">dist</span><span class="p">;</span>
            <span class="nx">cnt</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">avg</span> <span class="o">/=</span> <span class="nx">cnt</span><span class="p">;</span>
        <span class="nx">placeObj</span><span class="p">.</span><span class="nx">avgdist</span><span class="o">=</span><span class="nx">avg</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cm">/* ret will be something like:</span>
<span class="cm">{</span>
<span class="cm">    &quot;Rocklin, California, US&quot;:</span>
<span class="cm">    {</span>
<span class="cm">        &quot;95677&quot;:{&quot;dist&quot;:0,&quot;lon&quot;:-121.2366,&quot;lat&quot;:38.7877,&quot;id&quot;:&quot;6232be7e18b&quot;,&quot;heading&quot;:&quot;N&quot;},</span>
<span class="cm">        &quot;95765&quot;:{&quot;dist&quot;:3.9415328848914677,&quot;lon&quot;:-121.2677,&quot;lat&quot;:38.8136,&quot;id&quot;:&quot;6232be7e1b2&quot;,&quot;heading&quot;:&quot;NW&quot;},</span>
<span class="cm">        &quot;avgdist&quot;:1.9707664424457338</span>
<span class="cm">    },</span>
<span class="cm">    &quot;Roseville, California, US&quot;:{</span>
<span class="cm">        &quot;95661&quot;:{&quot;dist&quot;:5.904624610176184,&quot;lon&quot;:-121.234,&quot;lat&quot;:38.7346,&quot;id&quot;:&quot;6232be7e185&quot;,&quot;heading&quot;:&quot;S&quot;},</span>
<span class="cm">        &quot;95678&quot;:{&quot;dist&quot;:5.2635315744972475,&quot;lon&quot;:-121.2867,&quot;lat&quot;:38.7609,&quot;id&quot;:&quot;6232be7e18e&quot;,&quot;heading&quot;:&quot;SW&quot;},</span>
<span class="cm">        &quot;95747&quot;:{&quot;dist&quot;:8.926222554334897,&quot;lon&quot;:-121.3372,&quot;lat&quot;:38.7703,&quot;id&quot;:&quot;6232be7e1af&quot;,&quot;heading&quot;:&quot;WSW&quot;},</span>
<span class="cm">        &quot;avgdist&quot;:6.698126246336109</span>
<span class="cm">    },</span>
<span class="cm">    ...</span>
<span class="cm">}</span>
<span class="cm">*/</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This function groups each <code class="docutils literal notranslate"><span class="pre">place</span></code> (city) name and adds the rows indexed by
the property <code class="docutils literal notranslate"><span class="pre">postal_code</span></code> (AKA zip code in the US).  It also calculates
an average distance for each <code class="docutils literal notranslate"><span class="pre">postal_code</span></code> and adds that as the property
<code class="docutils literal notranslate"><span class="pre">avgdist</span></code>.</p>
<p>Using that function, we can update our <code class="docutils literal notranslate"><span class="pre">ajaxres()</span></code> function to look like
this:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">ajaxres</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">lon</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">lon</span><span class="p">,</span> <span class="nx">lat</span><span class="o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">lat</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">lon</span> <span class="o">||</span> <span class="o">!</span><span class="nx">lat</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span><span class="p">{}};</span>

    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`SELECT</span>
<span class="sb">        place_name +&#39;, &#39; + admin_name1 + &#39;, &#39; + country_code place,</span>
<span class="sb">        id, postal_code, latitude, longitude,</span>
<span class="sb">        DISTLATLON(?lat, ?lon, latitude, longitude) dist,</span>
<span class="sb">        AZIMUTH2COMPASS( AZIMUTHLATLON(?lat, ?lon, latitude, longitude), 3 ) heading</span>
<span class="sb">        FROM geonames WHERE</span>
<span class="sb">        geocode BETWEEN (SELECT LATLON2GEOCODEAREA(?lat, ?lon, 1.0))</span>
<span class="sb">        ORDER BY 6 ASC;`</span><span class="p">,</span>
        <span class="p">{</span><span class="nx">lat</span><span class="o">:</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="o">:</span><span class="nx">lon</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">maxRows</span><span class="o">:</span> <span class="mi">100</span> <span class="p">}</span>
    <span class="p">);</span>

    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">{</span><span class="nx">cities</span><span class="o">:</span> <span class="nx">reorg_places</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">)};</span>

    <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span><span class="nx">ret</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is looking good so far.  However the client-side JavaScript
also needs to look up by the location <code class="docutils literal notranslate"><span class="pre">id</span></code> column.  and when it
does so, it will also need to provide the name and postal code of
that location. So we will add a bit more functionality to
<code class="docutils literal notranslate"><span class="pre">ajaxres()</span></code> for our final version:</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">ajaxres</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">id_res</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">lon</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">lon</span><span class="p">,</span> <span class="nx">lat</span><span class="o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">lat</span><span class="p">;</span>

    <span class="c1">// if we are given an id, look up the lat/lon</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">id_res</span><span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;place_name +&#39;, &#39; + admin_name1 + &#39;, &#39; + postal_code + &#39;, &#39; +country_code place, &quot;</span>  <span class="o">+</span>
            <span class="s2">&quot;postal_code zip, latitude lat, longitude lon &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;FROM geonames WHERE id=?;&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
        <span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id_res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">lon</span><span class="o">=</span><span class="nx">id_res</span><span class="p">.</span><span class="nx">lon</span><span class="p">;</span>
            <span class="nx">lat</span><span class="o">=</span><span class="nx">id_res</span><span class="p">.</span><span class="nx">lat</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">lon</span> <span class="o">||</span> <span class="o">!</span><span class="nx">lat</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span><span class="p">{}};</span>

    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`SELECT</span>
<span class="sb">        place_name +&#39;, &#39; + admin_name1 + &#39;, &#39; + country_code place,</span>
<span class="sb">        id, postal_code, latitude, longitude,</span>
<span class="sb">        DISTLATLON(?lat, ?lon, latitude, longitude) dist,</span>
<span class="sb">        AZIMUTH2COMPASS( AZIMUTHLATLON(?lat, ?lon, latitude, longitude), 3 ) heading</span>
<span class="sb">        FROM geonames WHERE</span>
<span class="sb">        geocode BETWEEN (SELECT LATLON2GEOCODEAREA(?lat, ?lon, 1.0))</span>
<span class="sb">        ORDER BY 6 ASC;`</span><span class="p">,</span>
        <span class="p">{</span><span class="nx">lat</span><span class="o">:</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="o">:</span><span class="nx">lon</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">maxRows</span><span class="o">:</span> <span class="mi">100</span> <span class="p">}</span>
    <span class="p">);</span>
    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">{</span><span class="nx">cities</span><span class="o">:</span> <span class="nx">reorg_places</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">)};</span>

    <span class="c1">// if look up by id, add name and zip for display</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">place</span> <span class="o">=</span> <span class="nx">id_res</span><span class="p">.</span><span class="nx">place</span><span class="p">;</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">zip</span> <span class="o">=</span> <span class="nx">id_res</span><span class="p">.</span><span class="nx">zip</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span><span class="nx">ret</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="the-complete-server-side-script">
<h3>The Complete Server-Side Script<a class="headerlink" href="#the-complete-server-side-script" title="Permalink to this headline">¶</a></h3>
<p>We now have all we need to perform the autocomplete search and nearest
city search.  This is the final script which, as layed out may be accessed
at <code class="docutils literal notranslate"><span class="pre">http://localhost:8088/apps/citysearch/</span></code>.</p>
<div class="highlight-javascript notranslate"><div class="highlight"><pre><span></span><span class="c1">// Load the sql module</span>
<span class="kd">var</span> <span class="nx">Sql</span><span class="o">=</span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;rampart-sql&quot;</span><span class="p">);</span>

<span class="c1">// serverConf is defined in web_server/web_server_conf.js</span>
<span class="kd">var</span> <span class="nx">sql</span><span class="o">=</span><span class="k">new</span> <span class="nx">Sql</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">serverConf</span><span class="p">.</span><span class="nx">dataRoot</span> <span class="o">+</span> <span class="s1">&#39;/geonames_db&#39;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">useKilometers</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">distvar</span> <span class="o">=</span> <span class="s2">&quot;mi&quot;</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="nx">useKilometers</span><span class="p">)</span>
    <span class="nx">distvar</span> <span class="o">=</span> <span class="s2">&quot;km&quot;</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">client_script</span> <span class="o">=</span> <span class="sb">`</span>
<span class="sb">// function to get query parameters from url</span>
<span class="sb">function getparams() {</span>
<span class="sb">    if (window.location.search.length==0)</span>
<span class="sb">        return {};</span>

<span class="sb">    var qstr  = window.location.search.substring(1);</span>
<span class="sb">    var pairs = qstr.split(&#39;&amp;&#39;);</span>
<span class="sb">    var ret = {}, i=0;</span>

<span class="sb">    for (i = 0; i &lt; pairs.length; i++) {</span>
<span class="sb">        var kv = pairs[i].split(&#39;=&#39;);</span>
<span class="sb">        ret[kv[0]]=kv[1];</span>
<span class="sb">    }</span>
<span class="sb">    return ret;</span>
<span class="sb">};</span>

<span class="sb">$(document).ready(function(){</span>

<span class="sb">    var curzip, curid;</span>
<span class="sb">    var params = getparams();</span>

<span class="sb">    // format the results, stick them in the div below the search form</span>
<span class="sb">    // update url to match state if curid is set</span>
<span class="sb">    function format_res(res_cities) {</span>
<span class="sb">        var resdiv = $(&#39;#res&#39;);</span>
<span class="sb">        var places = Object.keys(res_cities);</span>
<span class="sb">        var reshtml=&quot;&lt;h2&gt;Closest places to &quot; + $(&#39;#cstextbox&#39;).val() +&#39;&lt;/h2&gt;&#39;;;</span>
<span class="sb">        resdiv.html(&#39;&#39;);</span>

<span class="sb">        for (var i=0;i&lt;places.length;i++) {</span>
<span class="sb">            var j=0, place=places[i];</span>
<span class="sb">            var placeObj = res_cities[place];</span>
<span class="sb">            var zkeys = Object.keys(placeObj);</span>
<span class="sb">            var ziphtml=&#39;&#39;;</span>
<span class="sb">            var is_self=false; //flag if we are processing zip codes in the current city</span>

<span class="sb">            for(j=0;j&lt;zkeys.length;j++) {</span>
<span class="sb">                var zip=zkeys[j];</span>
<span class="sb">                if(zip == &#39;avgdist&#39;)</span>
<span class="sb">                    continue;</span>
<span class="sb">                if(zip == curzip ) {</span>
<span class="sb">                    is_self=true;</span>
<span class="sb">                    continue;</span>
<span class="sb">                }</span>
<span class="sb">                var zipObj = placeObj[zip];</span>
<span class="sb">                //console.log(zipObj);</span>
<span class="sb">                ziphtml+=&#39;&lt;a class=&quot;zip&quot; href=&quot;#&quot; data-zip=&quot;&#39; + zip + &#39;&quot; data-lat=&quot;&#39; + zipObj.lat + &#39;&quot; data-lon=&quot;&#39; +</span>
<span class="sb">                         zipObj.lon + &#39;&quot; data-id=&quot;&#39; + zipObj.id + &#39;&quot;&gt;&#39; + zip + &#39;(&#39; + zipObj.dist.toFixed(1) +</span>
<span class="sb">                         &#39;&amp;nbsp;&#39; + zipObj.heading + &#39;)&lt;/a&gt; &#39;;</span>
<span class="sb">            }</span>
<span class="sb">            if(ziphtml) {// skip self if only one zip.</span>
<span class="sb">                if(is_self)</span>
<span class="sb">                    reshtml += &#39;&lt;span&gt;&lt;h3&gt;Other zip codes in &lt;span class=&quot;place&quot;&gt;&#39; + place + &#39;&lt;/span&gt;&lt;/h3&gt;&#39;</span>
<span class="sb">                            + ziphtml + &quot;&lt;/span&gt;&quot;;</span>
<span class="sb">                else</span>
<span class="sb">                    reshtml += &#39;&lt;span&gt;&lt;h3&gt;&lt;span class=&quot;place&quot;&gt;&#39; + place + &#39;&lt;/span&gt; (&#39; +</span>
<span class="sb">                                parseFloat(placeObj.avgdist).toFixed(1)  +&#39; </span><span class="si">${</span><span class="nx">distvar</span><span class="si">}</span><span class="sb">.)&lt;/h3&gt;&#39; +</span>
<span class="sb">                                ziphtml + &quot;&lt;/span&gt;&quot;;</span>
<span class="sb">            }</span>
<span class="sb">        }</span>
<span class="sb">        resdiv.html(reshtml);</span>

<span class="sb">        if(curid){</span>
<span class="sb">            var nurl = window.location.origin + window.location.pathname + &#39;?id=&#39; + curid;</span>
<span class="sb">            window.history.pushState({},&#39;&#39;,nurl);</span>
<span class="sb">        }</span>
<span class="sb">    }</span>

<span class="sb">    // Use &#39;body&#39; and filter with class &#39;zip&#39; so the event will pick up not-yet-written content</span>
<span class="sb">    $(&#39;body&#39;).on(&#39;click&#39;,&#39;.zip&#39;,function(e) {</span>
<span class="sb">        //perform a new search on the zip code that was clicked.</span>
<span class="sb">        var t = $(this);</span>
<span class="sb">        var lat = t.attr(&#39;data-lat&#39;),</span>
<span class="sb">            lon=t.attr(&#39;data-lon&#39;),</span>
<span class="sb">            zip=t.attr(&#39;data-zip&#39;);</span>
<span class="sb">        var place = t.closest(&#39;span&#39;).find(&#39;.place&#39;).text();</span>

<span class="sb">        //curid is for the change of url in order to save the state.</span>
<span class="sb">        curid = t.attr(&#39;data-id&#39;);</span>

<span class="sb">        // recreate the place name with the zip code in it</span>
<span class="sb">        place = place.substring(0, place.length-2) +zip + &#39;, &#39; + place.substring(place.length-2, place.length);</span>
<span class="sb">        // put it in the search box</span>
<span class="sb">        $(&#39;#cstextbox&#39;).val(place);</span>

<span class="sb">        // fetch new list of closest cities and display</span>
<span class="sb">        $.getJSON(</span>
<span class="sb">            &quot;/apps/citysearch/ajaxres.json&quot;,</span>
<span class="sb">            {lat:lat, lon: lon},</span>
<span class="sb">            function(res) {</span>
<span class="sb">                curzip=zip;</span>
<span class="sb">                format_res(res.cities);</span>
<span class="sb">            }</span>
<span class="sb">        );</span>
<span class="sb">        return false; //don&#39;t actually go to the href in the clicked &lt;a&gt;</span>
<span class="sb">    });</span>

<span class="sb">    // the autocomplete plugin from  https://github.com/devbridge/jQuery-Autocomplete</span>
<span class="sb">    // jquery and plugin included from cloudflare in &lt;script src=&quot;xyz&quot;&gt; tags above.</span>
<span class="sb">    $(&#39;#cstextbox&#39;).autocomplete(</span>
<span class="sb">        {</span>
<span class="sb">            serviceUrl: &#39;/apps/citysearch/autocomp.json&#39;,</span>
<span class="sb">            minChars: 2,</span>
<span class="sb">            autoSelectFirst: true,</span>
<span class="sb">            showNoSuggestionNotice: true,</span>
<span class="sb">            onSelect: function(sel)</span>
<span class="sb">            {</span>
<span class="sb">                $.getJSON(</span>
<span class="sb">                    &quot;/apps/citysearch/ajaxres.json&quot;,</span>
<span class="sb">                    {lat:sel.latitude, lon: sel.longitude},</span>
<span class="sb">                    function(res) {</span>
<span class="sb">                        curzip = sel.zip;</span>
<span class="sb">                        curid = sel.id;</span>
<span class="sb">                        format_res(res.cities);</span>
<span class="sb">                    }</span>
<span class="sb">                );</span>
<span class="sb">            }</span>
<span class="sb">        }</span>
<span class="sb">    );</span>

<span class="sb">    // prevent form submission - all results are already in the autocomplete</span>
<span class="sb">    $(&#39;#cstextbox&#39;).on(&#39;keypress&#39;, function(e){</span>
<span class="sb">        var key = e.charCode || e.keyCode || 0;</span>
<span class="sb">        if (key == 13) {</span>
<span class="sb">            e.preventDefault();</span>
<span class="sb">            return false;</span>
<span class="sb">        }</span>
<span class="sb">    });</span>

<span class="sb">    function refresh(id) {</span>
<span class="sb">        $.getJSON(</span>
<span class="sb">            &quot;/apps/citysearch/ajaxres.json&quot;,</span>
<span class="sb">            {id:params.id},</span>
<span class="sb">            function(res) {</span>
<span class="sb">                curzip = res.zip;</span>
<span class="sb">                $(&#39;#cstextbox&#39;).val(res.place);</span>
<span class="sb">                //no curid necessary here</span>
<span class="sb">                format_res(res.cities);</span>
<span class="sb">            }</span>
<span class="sb">        );</span>
<span class="sb">    }</span>
<span class="sb">    // if we refresh the page, then reload the content</span>
<span class="sb">    if(params.id) {</span>
<span class="sb">        refresh(params.id);</span>
<span class="sb">    }</span>

<span class="sb">    window.onpopstate = function(event) {</span>
<span class="sb">        // url has changed, but page was not reloaded</span>
<span class="sb">        params = getparams();</span>
<span class="sb">        curid=false;</span>
<span class="sb">        if(params.id)</span>
<span class="sb">            refresh(params.id);</span>
<span class="sb">        else {</span>
<span class="sb">            $(&#39;#cstextbox&#39;).val(&#39;&#39;);</span>
<span class="sb">            $(&#39;#res&#39;).html(&#39;&#39;);</span>
<span class="sb">        }</span>
<span class="sb">    };</span>

<span class="sb">});</span>
<span class="sb">`</span><span class="p">;</span>


<span class="c1">// page is defined once upon script load here rather than upon each request in</span>
<span class="c1">// htmlpage() below.</span>
<span class="kd">var</span> <span class="nx">page</span><span class="o">=</span><span class="sb">`&lt;!DOCTYPE HTML&gt;</span>
<span class="sb">&lt;html&gt;</span>
<span class="sb">    &lt;head&gt;&lt;meta charset=&quot;utf-8&quot;&gt;</span>
<span class="sb">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="sb">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.4.11/jquery.autocomplete.min.js&quot;&gt;&lt;/script&gt;</span>
<span class="sb">    &lt;style&gt;</span>
<span class="sb">        body,h1,h2,h3,h4,h5,h6 {font-family: &quot;Varela Round&quot;, Sans-Serif;}</span>
<span class="sb">        .autocomplete-suggestions {</span>
<span class="sb">            border: 1px solid #999;</span>
<span class="sb">            background: #FFF;</span>
<span class="sb">            overflow: auto;</span>
<span class="sb">            width: auto !important;</span>
<span class="sb">            padding-right:5px;</span>
<span class="sb">        }</span>
<span class="sb">        .autocomplete-suggestion {</span>
<span class="sb">            padding: 2px 5px;</span>
<span class="sb">            white-space: nowrap;</span>
<span class="sb">            overflow: hidden;</span>
<span class="sb">        }</span>
<span class="sb">        .autocomplete-suggestions strong {</span>
<span class="sb">            font-weight: normal;</span>
<span class="sb">            color: #3399FF;</span>
<span class="sb">        }</span>
<span class="sb">        .autocomplete-group strong {</span>
<span class="sb">            display: block;</span>
<span class="sb">            border-bottom: 1px solid #000;</span>
<span class="sb">        }</span>
<span class="sb">        .autocomplete-selected { background: #F0F0F0; }</span>
<span class="sb">        .autocomplete-group { padding: 2px 5px; }</span>
<span class="sb">        .zip { display: inline-block; width:140px;}</span>
<span class="sb">        #main {</span>
<span class="sb">            background-color: white;</span>
<span class="sb">            margin: auto;</span>
<span class="sb">            min-height: 300px;</span>
<span class="sb">            width: 600px;</span>
<span class="sb">        }</span>
<span class="sb">        #idiv {</span>
<span class="sb">            width:500px;</span>
<span class="sb">            height:39px;</span>
<span class="sb">            border-bottom: lightGray 1px solid;</span>
<span class="sb">            padding:15px 0px 15px 0px;</span>
<span class="sb">        }</span>
<span class="sb">        #cstextbox {</span>
<span class="sb">            min-width:150px;</span>
<span class="sb">            width:100%;</span>
<span class="sb">            height:30px;</span>
<span class="sb">            font:normal 18px arial,sans-serif;</span>
<span class="sb">            padding: 1px 3px;</span>
<span class="sb">            border: 2px solid #ccc;</span>
<span class="sb">            box-sizing: border-box;</span>
<span class="sb">        }</span>
<span class="sb">    &lt;/style&gt;</span>
<span class="sb">    &lt;title&gt;City Search Tutorial&lt;/title&gt;</span>
<span class="sb">    &lt;/head&gt;</span>
<span class="sb">    &lt;body&gt;</span>
<span class="sb">    &lt;div id=&quot;main&quot;&gt;</span>
<span class="sb">      &lt;form id=&quot;mf&quot;&gt;</span>
<span class="sb">          &lt;div id=&quot;idiv&quot;&gt;</span>
<span class="sb">              &lt;input type=&quot;text&quot; id=&quot;cstextbox&quot; name=&quot;q&quot; value=&quot;&quot; placeholder=&quot;Search for a city&quot;&gt;</span>
<span class="sb">          &lt;/div&gt;</span>
<span class="sb">      &lt;/form&gt;</span>
<span class="sb">      &lt;div id=&quot;res&quot;&gt;&lt;/div&gt;</span>
<span class="sb">      &lt;/body&gt;</span>
<span class="sb">      &lt;script&gt;</span>
<span class="sb">          </span><span class="si">${</span><span class="nx">client_script</span><span class="si">}</span><span class="sb"></span>
<span class="sb">      &lt;/script&gt;</span>
<span class="sb">&lt;/html&gt;`</span><span class="p">;</span>



<span class="kd">function</span> <span class="nx">htmlpage</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// just return the html.</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">html</span><span class="o">:</span><span class="nx">page</span><span class="p">};</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="nx">distconv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="nx">useKilometers</span><span class="p">)</span>
    <span class="nx">distconv</span><span class="o">=</span><span class="mf">1.60934</span>

<span class="c1">// reorganize our data for easy handling client side.</span>
<span class="kd">function</span> <span class="nx">reorg_places</span><span class="p">(</span><span class="nx">places</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">ret</span><span class="o">=</span><span class="p">{};</span>
    <span class="cm">/* group by city, with entries for distance for each zip code */</span>
    <span class="k">for</span> <span class="p">(;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">places</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">places</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">ret</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">place</span><span class="p">])</span>
            <span class="nx">ret</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">place</span><span class="p">]</span><span class="o">=</span><span class="p">{};</span>
        <span class="nx">ret</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">place</span><span class="p">][</span><span class="nx">p</span><span class="p">.</span><span class="nx">postal_code</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">dist</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">dist</span> <span class="o">*</span> <span class="nx">distconv</span><span class="p">,</span>
            <span class="nx">lon</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">longitude</span><span class="p">,</span>
            <span class="nx">lat</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">latitude</span><span class="p">,</span>
            <span class="nx">id</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
            <span class="nx">heading</span><span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">heading</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="c1">// calc average distance</span>
    <span class="kd">var</span> <span class="nx">keys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">ret</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">placeName</span> <span class="o">=</span> <span class="nx">keys</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">placeObj</span> <span class="o">=</span> <span class="nx">ret</span><span class="p">[</span><span class="nx">placeName</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">zkeys</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">placeObj</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">cnt</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">avg</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">j</span><span class="o">&lt;</span><span class="nx">zkeys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">zkey</span> <span class="o">=</span> <span class="nx">zkeys</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>
            <span class="nx">avg</span> <span class="o">+=</span> <span class="nx">placeObj</span><span class="p">[</span><span class="nx">zkey</span><span class="p">].</span><span class="nx">dist</span><span class="p">;</span>
            <span class="nx">cnt</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">avg</span> <span class="o">/=</span> <span class="nx">cnt</span><span class="p">;</span>
        <span class="nx">placeObj</span><span class="p">.</span><span class="nx">avgdist</span><span class="o">=</span><span class="nx">avg</span><span class="p">;</span>
    <span class="p">}</span>

<span class="cm">/* ret will be something like:</span>
<span class="cm">{</span>
<span class="cm">    &quot;Rocklin, California, US&quot;:</span>
<span class="cm">    {</span>
<span class="cm">        &quot;95677&quot;:{&quot;dist&quot;:0,&quot;lon&quot;:-121.2366,&quot;lat&quot;:38.7877,&quot;id&quot;:&quot;6232be7e18b&quot;,&quot;heading&quot;:&quot;N&quot;},</span>
<span class="cm">        &quot;95765&quot;:{&quot;dist&quot;:3.9415328848914677,&quot;lon&quot;:-121.2677,&quot;lat&quot;:38.8136,&quot;id&quot;:&quot;6232be7e1b2&quot;,&quot;heading&quot;:&quot;NW&quot;},</span>
<span class="cm">        &quot;avgdist&quot;:1.9707664424457338</span>
<span class="cm">    },</span>
<span class="cm">    &quot;Roseville, California, US&quot;:{</span>
<span class="cm">        &quot;95661&quot;:{&quot;dist&quot;:5.904624610176184,&quot;lon&quot;:-121.234,&quot;lat&quot;:38.7346,&quot;id&quot;:&quot;6232be7e185&quot;,&quot;heading&quot;:&quot;S&quot;},</span>
<span class="cm">        &quot;95678&quot;:{&quot;dist&quot;:5.2635315744972475,&quot;lon&quot;:-121.2867,&quot;lat&quot;:38.7609,&quot;id&quot;:&quot;6232be7e18e&quot;,&quot;heading&quot;:&quot;SW&quot;},</span>
<span class="cm">        &quot;95747&quot;:{&quot;dist&quot;:8.926222554334897,&quot;lon&quot;:-121.3372,&quot;lat&quot;:38.7703,&quot;id&quot;:&quot;6232be7e1af&quot;,&quot;heading&quot;:&quot;WSW&quot;},</span>
<span class="cm">        &quot;avgdist&quot;:6.698126246336109</span>
<span class="cm">    },</span>
<span class="cm">    ...</span>
<span class="cm">}</span>
<span class="cm">*/</span>
    <span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">ajaxres</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">id_res</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">lon</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">lon</span><span class="p">,</span> <span class="nx">lat</span><span class="o">=</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">lat</span><span class="p">;</span>

    <span class="c1">// if we are given an id, look up the lat/lon</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">id_res</span><span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">one</span><span class="p">(</span><span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;place_name +&#39;, &#39; + admin_name1 + &#39;, &#39; + postal_code + &#39;, &#39; +country_code place, &quot;</span>  <span class="o">+</span>
            <span class="s2">&quot;postal_code zip, latitude lat, longitude lon &quot;</span> <span class="o">+</span>
            <span class="s2">&quot;FROM geonames WHERE id=?;&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span>
        <span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id_res</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">lon</span><span class="o">=</span><span class="nx">id_res</span><span class="p">.</span><span class="nx">lon</span><span class="p">;</span>
            <span class="nx">lat</span><span class="o">=</span><span class="nx">id_res</span><span class="p">.</span><span class="nx">lat</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">lon</span> <span class="o">||</span> <span class="o">!</span><span class="nx">lat</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span><span class="p">{}};</span>

    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`SELECT</span>
<span class="sb">        place_name +&#39;, &#39; + admin_name1 + &#39;, &#39; + country_code place,</span>
<span class="sb">        id, postal_code, latitude, longitude,</span>
<span class="sb">        DISTLATLON(?lat, ?lon, latitude, longitude) dist,</span>
<span class="sb">        AZIMUTH2COMPASS( AZIMUTHLATLON(?lat, ?lon, latitude, longitude), 3 ) heading</span>
<span class="sb">        FROM geonames WHERE</span>
<span class="sb">        geocode BETWEEN (SELECT LATLON2GEOCODEAREA(?lat, ?lon, 1.0))</span>
<span class="sb">        ORDER BY 6 ASC;`</span><span class="p">,</span>
        <span class="p">{</span><span class="nx">lat</span><span class="o">:</span><span class="nx">lat</span><span class="p">,</span> <span class="nx">lon</span><span class="o">:</span><span class="nx">lon</span><span class="p">},</span>
        <span class="p">{</span><span class="nx">maxRows</span><span class="o">:</span> <span class="mi">100</span> <span class="p">}</span>
    <span class="p">);</span>

    <span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span> <span class="p">{</span><span class="nx">cities</span><span class="o">:</span> <span class="nx">reorg_places</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">)};</span>

    <span class="c1">// if look up by id, add name and zip for display</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">place</span> <span class="o">=</span> <span class="nx">id_res</span><span class="p">.</span><span class="nx">place</span><span class="p">;</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">zip</span> <span class="o">=</span> <span class="nx">id_res</span><span class="p">.</span><span class="nx">zip</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span><span class="nx">ret</span><span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* autocomp() results must be formatted as such:</span>
<span class="cm">{</span>
<span class="cm">    &quot;suggestions&quot;: [</span>
<span class="cm">        {&quot;value&quot;:&quot;Vaulion, Canton de Vaud, 1325, CH&quot;,&quot;id&quot;:&quot;6233eaf65bd&quot;,&quot;latitude&quot;:46.6848,&quot;longitude&quot;:6.3832,&quot;zip&quot;:&quot;1325&quot;},</span>
<span class="cm">        {&quot;value&quot;:&quot;Vallorbe, Canton de Vaud, 1337, CH&quot;,&quot;id&quot;:&quot;6233eaf65c6&quot;,&quot;latitude&quot;:46.7078,&quot;longitude&quot;:6.3714,&quot;zip&quot;:&quot;1337&quot;},</span>
<span class="cm">        {&quot;value&quot;:&quot;Valeyres-sous-Rances, Canton de Vaud, 1358, CH&quot;,&quot;id&quot;:&quot;6233eaf6608&quot;,&quot;latitude&quot;:46.7482,&quot;longitude&quot;:6.5354,&quot;zip&quot;:&quot;1358&quot;},</span>
<span class="cm">        {&quot;value&quot;:&quot;Valeyres-sous-Ursins, Canton de Vaud, 1412, CH&quot;,&quot;id&quot;:&quot;6233eaf663b&quot;,&quot;latitude&quot;:46.7453,&quot;longitude&quot;:6.6533,&quot;zip&quot;:&quot;1412&quot;},</span>
<span class="cm">        ...</span>
<span class="cm">    ]</span>
<span class="cm">}</span>
<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">autocomp</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">q</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span>

    <span class="c1">// ignore one character partial words</span>

    <span class="c1">// remove any spaces at the beginning of q</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^\s+/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>

    <span class="c1">// if query is only one char, return an empty set</span>
    <span class="c1">//   (even though client-side autocomplete is set to 2 char min)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="p">[]}}</span>

    <span class="c1">// we will need at least two chars in our last word</span>
    <span class="c1">// since it will get a &#39;*&#39; wildcard added to it</span>
    <span class="nx">q</span> <span class="o">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ \S$/</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">);</span>


    <span class="c1">// if last character is not a space, add wildcard</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">q</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="nx">q</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span><span class="p">;</span>

    <span class="nx">sql</span><span class="p">.</span><span class="nx">set</span><span class="p">({</span>
        <span class="s1">&#39;likepAllmatch&#39;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>  <span class="c1">// match every word or partial word</span>
        <span class="s1">&#39;qMaxWords&#39;</span>    <span class="o">:</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1">// allow query and sets to be larger than normal for &#39;*&#39; wildcard searches</span>
        <span class="s1">&#39;qMaxSetWords&#39;</span> <span class="o">:</span> <span class="mi">5000</span>   <span class="c1">// see https://rampart.dev/docs/sql-set.html#qmaxsetwords</span>
                                <span class="c1">// and https://rampart.dev/docs/sql-set.html#qmaxwords .</span>
    <span class="p">});</span>

    <span class="c1">// perform a text search on the words or partial words we have, and return a list of best matching locations</span>
    <span class="nx">res</span> <span class="o">=</span> <span class="nx">sql</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="sb">`SELECT</span>
<span class="sb">        place_name +&#39;, &#39; + admin_name1 + &#39;, &#39; + postal_code + &#39;, &#39; + country_code value,</span>
<span class="sb">        id, latitude, longitude, postal_code zip</span>
<span class="sb">        FROM geonames WHERE</span>
<span class="sb">        place_name\\postal_code\\admin_name1\\admin_code1\\country_code\\admin_name2\\admin_code2\\admin_name3\\admin_code3</span>
<span class="sb">        LIKEP ?;`</span><span class="p">,</span>
        <span class="p">[</span><span class="nx">q</span><span class="p">]</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">json</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;suggestions&quot;</span><span class="o">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">rows</span><span class="p">}};</span>
<span class="p">}</span>

<span class="c1">// url to function mapping</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;/&quot;</span><span class="o">:</span>               <span class="nx">htmlpage</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/</span>
    <span class="s2">&quot;/index.html&quot;</span><span class="o">:</span>     <span class="nx">htmlpage</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/index.html</span>
    <span class="s2">&quot;/autocomp.json&quot;</span><span class="o">:</span>  <span class="nx">autocomp</span><span class="p">,</span>  <span class="c1">//http://localhost:8088/apps/citysearch/autocomp.json</span>
    <span class="s2">&quot;/ajaxres.json&quot;</span><span class="o">:</span>   <span class="nx">ajaxres</span>    <span class="c1">//http://localhost:8088/apps/citysearch/ajaxres.json</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Enjoy.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tutorial-wschat.html" class="btn btn-neutral float-right" title="Using Websockets to Build a Chat" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorialtoc.html" class="btn btn-neutral" title="Tutorials" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, Moat Crossing Systems.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> and ❤️  using a custom <a href="https://github.com/LinxiFan/Sphinx-theme">theme</a> based on <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>
      <script type="text/javascript" src="_static/language_data.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>